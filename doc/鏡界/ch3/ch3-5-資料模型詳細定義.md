**[â† è¿”å›ç¬¬3ç« é¦–é ](ch3-index.md)**

---

### 3.5 è³‡æ–™æ¨¡å‹è©³ç´°å®šç¾©

#### 3.5.1 å¥åº·æª¢æ¸¬çµæœè¡¨ (health_check_results)

æ­¤è¡¨è¨˜éŒ„æ¯æ¬¡å¥åº·æª¢æ¸¬çš„è©³ç´°çµæœï¼Œæ”¯æ´æ™‚åºåˆ†æå’Œæ€§èƒ½ç›£æ§ã€‚

```sql
-- å»ºç«‹ç‹€æ…‹é¡å‹æšèˆ‰ï¼ˆå¼·åˆ¶è³‡æ–™ä¸€è‡´æ€§ï¼‰
CREATE TYPE health_status AS ENUM ('success', 'warning', 'error', 'timeout');

-- å¥åº·æª¢æ¸¬çµæœè¡¨
CREATE TABLE health_check_results (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    data_source_id UUID NOT NULL,
    
    -- æ™‚é–“æ¬„ä½ï¼šè¨˜éŒ„æª¢æ¸¬ç™¼ç”Ÿæ™‚é–“å’Œè³‡æ–™å¯«å…¥æ™‚é–“
    check_time TIMESTAMPTZ NOT NULL COMMENT 'æª¢æ¸¬åŸ·è¡Œæ™‚é–“ï¼ˆç”¨æ–¼æ™‚åºåˆ†æï¼‰',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW() COMMENT 'è³‡æ–™å¯«å…¥æ™‚é–“ï¼ˆç”¨æ–¼å¯©è¨ˆè¿½è¹¤ï¼‰',
    
    -- æª¢æ¸¬çµæœ
    status health_status NOT NULL COMMENT 'æª¢æ¸¬ç‹€æ…‹ï¼ˆsuccess/warning/error/timeoutï¼‰',
    response_time INT COMMENT 'éŸ¿æ‡‰æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰',
    
    -- éŒ¯èª¤è©³æƒ…ï¼ˆçµæ§‹åŒ–ä»¥æ”¯æ´ç¨‹å¼åŒ–å‘Šè­¦ï¼‰
    error_code VARCHAR(20) COMMENT 'éŒ¯èª¤ä»£ç¢¼ï¼ˆå¦‚ï¼šCONNECTION_TIMEOUT, DNS_FAILï¼‰',
    error_detail TEXT COMMENT 'è©³ç´°éŒ¯èª¤ä¿¡æ¯',
    
    -- æ“´å±•æ¬„ä½
    ssl_certificate_valid BOOLEAN COMMENT 'SSL è­‰æ›¸æ˜¯å¦æœ‰æ•ˆ',
    ssl_expiry_days INT COMMENT 'SSL è­‰æ›¸å‰©é¤˜å¤©æ•¸',
    content_hash VARCHAR(64) COMMENT 'å›æ‡‰å…§å®¹é›œæ¹Šï¼ˆç”¨æ–¼è®ŠåŒ–åµæ¸¬ï¼‰',
    
    -- å¤–éµç´„æŸï¼ˆé˜²æ­¢å­¤ç«‹è³‡æ–™ï¼‰
    CONSTRAINT fk_health_check_datasource 
        FOREIGN KEY (data_source_id) 
        REFERENCES data_sources(id) 
        ON DELETE CASCADE ON UPDATE CASCADE
);

-- è¤‡åˆç´¢å¼•å„ªåŒ–ï¼ˆåŠ é€Ÿç›£æ§æŸ¥è©¢å ´æ™¯ï¼‰
CREATE INDEX idx_health_check_datasource_time 
    ON health_check_results(data_source_id, check_time DESC);

CREATE INDEX idx_health_check_created_time 
    ON health_check_results(created_at DESC);

CREATE INDEX idx_health_check_status 
    ON health_check_results(data_source_id, status, check_time DESC);

-- åˆ†å€ç­–ç•¥ï¼ˆæ™‚åºè³‡æ–™å„ªåŒ–ï¼Œæ”¯æ´å¤§è¦æ¨¡ç›£æ§ï¼‰
CREATE TABLE health_check_results_2024_10 PARTITION OF health_check_results
    FOR VALUES FROM ('2024-10-01') TO ('2024-11-01');
CREATE TABLE health_check_results_2024_11 PARTITION OF health_check_results
    FOR VALUES FROM ('2024-11-01') TO ('2024-12-01');
```

**æ¬„ä½è¨­è¨ˆèªªæ˜ï¼š**
- `response_time` æ˜ç¢ºå–®ä½ç‚º **æ¯«ç§’ï¼ˆmsï¼‰**ï¼Œä¾¿æ–¼èˆ‡ SLA å°æ¨™
- `status` ä½¿ç”¨ ENUM é¡å‹ï¼Œå¼·åˆ¶æœ‰æ•ˆå€¼ï¼Œæå‡æŸ¥è©¢æ•ˆç‡
- `check_time` vs `created_at` åˆ†é›¢ï¼Œæ”¯æ´æ™‚åºåˆ†æå’Œå¯©è¨ˆ
- `error_code` çµæ§‹åŒ–éŒ¯èª¤è¨Šæ¯ï¼Œæ”¯æ´ç¨‹å¼åŒ–å‘Šè­¦è¦å‰‡é…ç½®

---

#### 3.5.2 å‘Šè­¦æ­·å²è¡¨ (alert_history)

æ­¤è¡¨è¨˜éŒ„æ‰€æœ‰å‘Šè­¦äº‹ä»¶åŠå…¶ç”Ÿå‘½é€±æœŸç‹€æ…‹ã€‚

```sql
-- å»ºç«‹å‘Šè­¦åš´é‡æ€§å’Œç‹€æ…‹æšèˆ‰
CREATE TYPE alert_severity AS ENUM ('info', 'warning', 'critical');
CREATE TYPE alert_status AS ENUM ('triggered', 'acknowledged', 'resolved', 'closed');

-- å‘Šè­¦æ­·å²è¡¨
CREATE TABLE alert_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    data_source_id UUID NOT NULL,
    
    -- å‘Šè­¦åŸºæœ¬ä¿¡æ¯
    alert_type VARCHAR(50) NOT NULL COMMENT 'å‘Šè­¦é¡å‹ï¼ˆå¦‚ï¼šresponse_time_high, connection_failedï¼‰',
    severity alert_severity NOT NULL COMMENT 'åš´é‡ç´šåˆ¥ï¼ˆinfo/warning/criticalï¼‰',
    
    -- å‘Šè­¦ç”Ÿå‘½é€±æœŸè¿½è¹¤
    status alert_status NOT NULL DEFAULT 'triggered' COMMENT 'å‘Šè­¦ç•¶å‰ç‹€æ…‹',
    message TEXT NOT NULL COMMENT 'å‘Šè­¦ä¿¡æ¯å…§å®¹',
    
    -- ç”Ÿå‘½é€±æœŸæ™‚é–“æˆ³
    triggered_at TIMESTAMPTZ NOT NULL DEFAULT NOW() COMMENT 'å‘Šè­¦è§¸ç™¼æ™‚é–“',
    acknowledged_at TIMESTAMPTZ COMMENT 'å‘Šè­¦ç¢ºèªæ™‚é–“',
    resolved_at TIMESTAMPTZ COMMENT 'å‘Šè­¦è§£æ±ºæ™‚é–“',
    closed_at TIMESTAMPTZ COMMENT 'å‘Šè­¦é—œé–‰æ™‚é–“',
    
    -- å‘Šè­¦è©³æƒ…
    metric_name VARCHAR(100) COMMENT 'å‘Šè­¦ç›¸é—œçš„æŒ‡æ¨™åç¨±',
    metric_value NUMERIC(10, 2) COMMENT 'è§¸ç™¼å‘Šè­¦çš„æŒ‡æ¨™å€¼',
    threshold NUMERIC(10, 2) COMMENT 'å‘Šè­¦é–¾å€¼',
    
    -- å‘Šè­¦è™•ç†
    assigned_to UUID COMMENT 'åˆ†é…çµ¦ï¼ˆæ“ä½œäººå“¡ IDï¼‰',
    notes TEXT COMMENT 'è™•ç†è¨»è¨˜',
    
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    
    -- å¤–éµç´„æŸ
    CONSTRAINT fk_alert_datasource 
        FOREIGN KEY (data_source_id) 
        REFERENCES data_sources(id) 
        ON DELETE CASCADE ON UPDATE CASCADE
);

-- ç´¢å¼•å„ªåŒ–ï¼ˆæ”¯æ´å¸¸è¦‹æŸ¥è©¢ï¼‰
CREATE INDEX idx_alert_datasource_status 
    ON alert_history(data_source_id, status, triggered_at DESC);

CREATE INDEX idx_alert_severity_triggered 
    ON alert_history(severity, triggered_at DESC);

CREATE INDEX idx_alert_triggered_time 
    ON alert_history(triggered_at DESC);

-- æ™‚é–“æˆ³è‡ªå‹•æ›´æ–°è§¸ç™¼å™¨
CREATE TRIGGER update_alert_updated_at
    BEFORE UPDATE ON alert_history
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

**æ¬„ä½è¨­è¨ˆèªªæ˜ï¼š**
- **å‘Šè­¦ç‹€æ…‹è¿½è¹¤**ï¼šæ–°å¢ `status` æ¬„ä½è¨˜éŒ„å®Œæ•´ç”Ÿå‘½é€±æœŸï¼ˆtriggered â†’ acknowledged â†’ resolved â†’ closedï¼‰
- **åš´é‡æ€§åˆ†ç´š**ï¼šä½¿ç”¨ ENUM é¡å‹å®šç¾©æ¨™æº–åˆ†ç´šï¼ˆinfo/warning/criticalï¼‰ï¼Œæ”¯æ´è·¨ç³»çµ±ä¸€è‡´æ€§
- **ç”Ÿå‘½é€±æœŸæ™‚é–“**ï¼š`triggered_at` / `acknowledged_at` / `resolved_at` / `closed_at` å®Œæ•´è¨˜éŒ„æ¯å€‹ç‹€æ…‹çš„æ™‚é–“
- **æŒ‡æ¨™çµæ§‹åŒ–**ï¼š`metric_name` / `metric_value` / `threshold` ä¾¿æ–¼åˆ†æå‘Šè­¦æ ¹æœ¬åŸå› 
- **äººå·¥å¹²é è¿½è¹¤**ï¼š`assigned_to` å’Œ `notes` æ”¯æ´å‘Šè­¦è™•ç†æµç¨‹ç®¡ç†

---

#### 3.5.3 å¥åº·æª¢æ¸¬èšåˆè¡¨ (health_check_summary)

æä¾›å¿«é€Ÿçš„å¥åº·ç‹€æ…‹çµ±è¨ˆï¼Œé¿å…é‡è¤‡æƒæåŸå§‹è³‡æ–™ã€‚

```sql
CREATE TABLE health_check_summary (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    data_source_id UUID NOT NULL,
    
    -- çµ±è¨ˆé€±æœŸ
    summary_date DATE NOT NULL,
    summary_hour INT COMMENT 'å°æ™‚ç´šåˆ¥ï¼ˆ0-23ï¼‰ï¼ŒNULL è¡¨ç¤ºæ—¥å½™ç¸½',
    
    -- çµ±è¨ˆæŒ‡æ¨™
    total_checks INT NOT NULL DEFAULT 0,
    successful_checks INT NOT NULL DEFAULT 0,
    failed_checks INT NOT NULL DEFAULT 0,
    warning_checks INT NOT NULL DEFAULT 0,
    
    -- æ€§èƒ½æŒ‡æ¨™
    avg_response_time INT COMMENT 'å¹³å‡éŸ¿æ‡‰æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰',
    max_response_time INT COMMENT 'æœ€å¤§éŸ¿æ‡‰æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰',
    min_response_time INT COMMENT 'æœ€å°éŸ¿æ‡‰æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰',
    p95_response_time INT COMMENT 'ç¬¬ 95 ç™¾åˆ†ä½éŸ¿æ‡‰æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰',
    
    -- å¯ç”¨æ€§è¨ˆç®—
    availability_percentage NUMERIC(5, 2) COMMENT 'å¯ç”¨ç‡ï¼ˆç™¾åˆ†æ¯”ï¼Œ0-100ï¼‰',
    
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    
    CONSTRAINT fk_summary_datasource 
        FOREIGN KEY (data_source_id) 
        REFERENCES data_sources(id),
    
    -- ç¢ºä¿æ¯å€‹æ•¸æ“šæºæ¯å€‹æ™‚é–“æ®µåªæœ‰ä¸€æ¢è¨˜éŒ„
    UNIQUE(data_source_id, summary_date, summary_hour)
);

-- ç´¢å¼•å„ªåŒ–
CREATE INDEX idx_summary_datasource_date 
    ON health_check_summary(data_source_id, summary_date DESC);
```

---

#### 3.5.4 å‘Šè­¦è¦å‰‡å®šç¾©è¡¨ (alert_rules)

å­˜å„²å‹•æ…‹å‘Šè­¦è¦å‰‡é…ç½®ï¼Œæ”¯æ´éˆæ´»çš„ç›£æ§ç­–ç•¥ã€‚

```sql
CREATE TYPE alert_condition AS ENUM ('gt', 'gte', 'lt', 'lte', 'eq', 'ne', 'in');

CREATE TABLE alert_rules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- è¦å‰‡åŸºæœ¬ä¿¡æ¯
    rule_name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    
    -- é©ç”¨ç¯„åœ
    data_source_id UUID COMMENT 'NULL è¡¨ç¤ºå…¨å±€è¦å‰‡',
    metric_name VARCHAR(100) NOT NULL,
    
    -- å‘Šè­¦æ¢ä»¶
    condition alert_condition NOT NULL COMMENT 'æ¯”è¼ƒæ“ä½œç¬¦',
    threshold NUMERIC(10, 2) NOT NULL,
    evaluation_window INT NOT NULL DEFAULT 300 COMMENT 'è©•ä¼°æ™‚é–“çª—å£ï¼ˆç§’ï¼‰',
    
    -- å‘Šè­¦é…ç½®
    alert_severity alert_severity NOT NULL,
    cooldown_seconds INT DEFAULT 300 COMMENT 'å‘Šè­¦å†·å»æœŸï¼ˆé¿å…é‡è¤‡å‘Šè­¦ï¼‰',
    
    -- é€šçŸ¥é…ç½®
    notify_channels VARCHAR(100)[] COMMENT 'é€šçŸ¥æ¸ é“ï¼ˆemail, slack, sms, dingdingï¼‰',
    notify_users UUID[] COMMENT 'é€šçŸ¥çš„ç”¨æˆ¶ ID åˆ—è¡¨',
    
    -- ç¨½æ ¸
    created_by UUID NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_by UUID,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_alert_rules_active 
    ON alert_rules(is_active, metric_name);
```

---

## ğŸ“‘ ç›¸é—œç« ç¯€

| å‰åº | ç•¶å‰ | å¾ŒçºŒ |
|-----|------|------|
| [3.4 æ ¸å¿ƒçµ„ä»¶è©³ç´°å¯¦ç¾](ch3-4-æ ¸å¿ƒçµ„ä»¶è©³ç´°å¯¦ç¾.md) | **3.5 è³‡æ–™æ¨¡å‹è©³ç´°å®šç¾©** | [3.6 APIè©³ç´°è¦ç¯„](ch3-6-APIè©³ç´°è¦ç¯„.md) |

**å¿«é€Ÿéˆæ¥ï¼š**
- [â† è¿”å›ç¬¬3ç« é¦–é ](ch3-index.md)
- [3.4 æ ¸å¿ƒçµ„ä»¶è©³ç´°å¯¦ç¾](ch3-4-æ ¸å¿ƒçµ„ä»¶è©³ç´°å¯¦ç¾.md)
- [3.6 APIè©³ç´°è¦ç¯„](ch3-6-APIè©³ç´°è¦ç¯„.md)
- **å®Œæ•´ä»£ç¢¼ç¤ºä¾‹**: [ä»£ç¢¼ç¤ºä¾‹ç´¢å¼•](../ch3-code-examples/)
