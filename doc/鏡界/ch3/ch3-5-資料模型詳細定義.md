**[← 返回第3章首頁](ch3-index.md)**

---

### 3.5 資料模型詳細定義

#### 3.5.1 健康檢測結果表 (health_check_results)

此表記錄每次健康檢測的詳細結果，支援時序分析和性能監控。

```sql
-- 建立狀態類型枚舉（強制資料一致性）
CREATE TYPE health_status AS ENUM ('success', 'warning', 'error', 'timeout');

-- 健康檢測結果表
CREATE TABLE health_check_results (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    data_source_id UUID NOT NULL,
    
    -- 時間欄位：記錄檢測發生時間和資料寫入時間
    check_time TIMESTAMPTZ NOT NULL COMMENT '檢測執行時間（用於時序分析）',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW() COMMENT '資料寫入時間（用於審計追蹤）',
    
    -- 檢測結果
    status health_status NOT NULL COMMENT '檢測狀態（success/warning/error/timeout）',
    response_time INT COMMENT '響應時間（毫秒）',
    
    -- 錯誤詳情（結構化以支援程式化告警）
    error_code VARCHAR(20) COMMENT '錯誤代碼（如：CONNECTION_TIMEOUT, DNS_FAIL）',
    error_detail TEXT COMMENT '詳細錯誤信息',
    
    -- 擴展欄位
    ssl_certificate_valid BOOLEAN COMMENT 'SSL 證書是否有效',
    ssl_expiry_days INT COMMENT 'SSL 證書剩餘天數',
    content_hash VARCHAR(64) COMMENT '回應內容雜湊（用於變化偵測）',
    
    -- 外鍵約束（防止孤立資料）
    CONSTRAINT fk_health_check_datasource 
        FOREIGN KEY (data_source_id) 
        REFERENCES data_sources(id) 
        ON DELETE CASCADE ON UPDATE CASCADE
);

-- 複合索引優化（加速監控查詢場景）
CREATE INDEX idx_health_check_datasource_time 
    ON health_check_results(data_source_id, check_time DESC);

CREATE INDEX idx_health_check_created_time 
    ON health_check_results(created_at DESC);

CREATE INDEX idx_health_check_status 
    ON health_check_results(data_source_id, status, check_time DESC);

-- 分區策略（時序資料優化，支援大規模監控）
CREATE TABLE health_check_results_2024_10 PARTITION OF health_check_results
    FOR VALUES FROM ('2024-10-01') TO ('2024-11-01');
CREATE TABLE health_check_results_2024_11 PARTITION OF health_check_results
    FOR VALUES FROM ('2024-11-01') TO ('2024-12-01');
```

**欄位設計說明：**
- `response_time` 明確單位為 **毫秒（ms）**，便於與 SLA 對標
- `status` 使用 ENUM 類型，強制有效值，提升查詢效率
- `check_time` vs `created_at` 分離，支援時序分析和審計
- `error_code` 結構化錯誤訊息，支援程式化告警規則配置

---

#### 3.5.2 告警歷史表 (alert_history)

此表記錄所有告警事件及其生命週期狀態。

```sql
-- 建立告警嚴重性和狀態枚舉
CREATE TYPE alert_severity AS ENUM ('info', 'warning', 'critical');
CREATE TYPE alert_status AS ENUM ('triggered', 'acknowledged', 'resolved', 'closed');

-- 告警歷史表
CREATE TABLE alert_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    data_source_id UUID NOT NULL,
    
    -- 告警基本信息
    alert_type VARCHAR(50) NOT NULL COMMENT '告警類型（如：response_time_high, connection_failed）',
    severity alert_severity NOT NULL COMMENT '嚴重級別（info/warning/critical）',
    
    -- 告警生命週期追蹤
    status alert_status NOT NULL DEFAULT 'triggered' COMMENT '告警當前狀態',
    message TEXT NOT NULL COMMENT '告警信息內容',
    
    -- 生命週期時間戳
    triggered_at TIMESTAMPTZ NOT NULL DEFAULT NOW() COMMENT '告警觸發時間',
    acknowledged_at TIMESTAMPTZ COMMENT '告警確認時間',
    resolved_at TIMESTAMPTZ COMMENT '告警解決時間',
    closed_at TIMESTAMPTZ COMMENT '告警關閉時間',
    
    -- 告警詳情
    metric_name VARCHAR(100) COMMENT '告警相關的指標名稱',
    metric_value NUMERIC(10, 2) COMMENT '觸發告警的指標值',
    threshold NUMERIC(10, 2) COMMENT '告警閾值',
    
    -- 告警處理
    assigned_to UUID COMMENT '分配給（操作人員 ID）',
    notes TEXT COMMENT '處理註記',
    
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    
    -- 外鍵約束
    CONSTRAINT fk_alert_datasource 
        FOREIGN KEY (data_source_id) 
        REFERENCES data_sources(id) 
        ON DELETE CASCADE ON UPDATE CASCADE
);

-- 索引優化（支援常見查詢）
CREATE INDEX idx_alert_datasource_status 
    ON alert_history(data_source_id, status, triggered_at DESC);

CREATE INDEX idx_alert_severity_triggered 
    ON alert_history(severity, triggered_at DESC);

CREATE INDEX idx_alert_triggered_time 
    ON alert_history(triggered_at DESC);

-- 時間戳自動更新觸發器
CREATE TRIGGER update_alert_updated_at
    BEFORE UPDATE ON alert_history
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

**欄位設計說明：**
- **告警狀態追蹤**：新增 `status` 欄位記錄完整生命週期（triggered → acknowledged → resolved → closed）
- **嚴重性分級**：使用 ENUM 類型定義標準分級（info/warning/critical），支援跨系統一致性
- **生命週期時間**：`triggered_at` / `acknowledged_at` / `resolved_at` / `closed_at` 完整記錄每個狀態的時間
- **指標結構化**：`metric_name` / `metric_value` / `threshold` 便於分析告警根本原因
- **人工干預追蹤**：`assigned_to` 和 `notes` 支援告警處理流程管理

---

#### 3.5.3 健康檢測聚合表 (health_check_summary)

提供快速的健康狀態統計，避免重複掃描原始資料。

```sql
CREATE TABLE health_check_summary (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    data_source_id UUID NOT NULL,
    
    -- 統計週期
    summary_date DATE NOT NULL,
    summary_hour INT COMMENT '小時級別（0-23），NULL 表示日彙總',
    
    -- 統計指標
    total_checks INT NOT NULL DEFAULT 0,
    successful_checks INT NOT NULL DEFAULT 0,
    failed_checks INT NOT NULL DEFAULT 0,
    warning_checks INT NOT NULL DEFAULT 0,
    
    -- 性能指標
    avg_response_time INT COMMENT '平均響應時間（毫秒）',
    max_response_time INT COMMENT '最大響應時間（毫秒）',
    min_response_time INT COMMENT '最小響應時間（毫秒）',
    p95_response_time INT COMMENT '第 95 百分位響應時間（毫秒）',
    
    -- 可用性計算
    availability_percentage NUMERIC(5, 2) COMMENT '可用率（百分比，0-100）',
    
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    
    CONSTRAINT fk_summary_datasource 
        FOREIGN KEY (data_source_id) 
        REFERENCES data_sources(id),
    
    -- 確保每個數據源每個時間段只有一條記錄
    UNIQUE(data_source_id, summary_date, summary_hour)
);

-- 索引優化
CREATE INDEX idx_summary_datasource_date 
    ON health_check_summary(data_source_id, summary_date DESC);
```

---

#### 3.5.4 告警規則定義表 (alert_rules)

存儲動態告警規則配置，支援靈活的監控策略。

```sql
CREATE TYPE alert_condition AS ENUM ('gt', 'gte', 'lt', 'lte', 'eq', 'ne', 'in');

CREATE TABLE alert_rules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- 規則基本信息
    rule_name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    
    -- 適用範圍
    data_source_id UUID COMMENT 'NULL 表示全局規則',
    metric_name VARCHAR(100) NOT NULL,
    
    -- 告警條件
    condition alert_condition NOT NULL COMMENT '比較操作符',
    threshold NUMERIC(10, 2) NOT NULL,
    evaluation_window INT NOT NULL DEFAULT 300 COMMENT '評估時間窗口（秒）',
    
    -- 告警配置
    alert_severity alert_severity NOT NULL,
    cooldown_seconds INT DEFAULT 300 COMMENT '告警冷卻期（避免重複告警）',
    
    -- 通知配置
    notify_channels VARCHAR(100)[] COMMENT '通知渠道（email, slack, sms, dingding）',
    notify_users UUID[] COMMENT '通知的用戶 ID 列表',
    
    -- 稽核
    created_by UUID NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_by UUID,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_alert_rules_active 
    ON alert_rules(is_active, metric_name);
```

---

## 📑 相關章節

| 前序 | 當前 | 後續 |
|-----|------|------|
| [3.4 核心組件詳細實現](ch3-4-核心組件詳細實現.md) | **3.5 資料模型詳細定義** | [3.6 API詳細規範](ch3-6-API詳細規範.md) |

**快速鏈接：**
- [← 返回第3章首頁](ch3-index.md)
- [3.4 核心組件詳細實現](ch3-4-核心組件詳細實現.md)
- [3.6 API詳細規範](ch3-6-API詳細規範.md)
- **完整代碼示例**: [代碼示例索引](../ch3-code-examples/)
