# 3.10 健康監測最佳實踐指南

**[← 返回第3章首頁](ch3-index.md)**

---

## 📋 目錄

1. [檢測策略](#檢測策略)
2. [告警配置](#告警配置)
3. [性能優化](#性能優化)
4. [常見問題](#常見問題)

---

## 檢測策略

### 1. 檢測頻率建議

| 資料源狀態 | 建議間隔 | 備註 |
|----------|--------|------|
| Healthy | 1 小時 | 穩定資料源 |
| Warning | 10 分鐘 | 需關注 |
| Error | 5 分鐘 | 需立即檢查 |
| Critical | 1 分鐘 | 實時監控 |

### 2. 多層檢測策略

```
第一層（基礎）- 每小時
  ✓ HTTP 連接
  ✓ DNS 解析
  ✓ 響應時間

第二層（深度）- 每 6 小時
  ✓ SSL 證書檢查
  ✓ 內容驗證
  ✓ 安全掃描

第三層（完整）- 每天
  ✓ 負載測試
  ✓ 性能基準
  ✓ 備份驗證
```

### 3. 檢測超時設置

```
推薦配置:
- 連接超時: 10 秒
- 讀取超時: 20 秒
- 總體超時: 30 秒
- 重試次數: 3 次
- 重試延遲: 2-5 秒
```

---

## 告警配置

### 1. 告警規則範本

```python
# 生產環境 - 嚴格
{
    'name': 'Production Critical',
    'level': 'critical',
    'condition': {
        'availability_min': 95,
        'response_time_max': 3000,
        'error_rate_max': 5
    },
    'channels': ['email', 'slack', 'dingtalk']
}

# 開發環境 - 寬鬆
{
    'name': 'Dev Warning',
    'level': 'warning',
    'condition': {
        'availability_min': 80,
        'response_time_max': 5000,
        'error_rate_max': 10
    },
    'channels': ['email']
}
```

### 2. 告警升級策略

```
第一級: Warning (10 分鐘未恢復)
第二級: Error (30 分鐘未恢復)
第三級: Critical (1 小時未恢復)
  └─> 升級通知 (手機、Slack、釘釘)
```

### 3. 告警抑制

```
推薦抑制規則:
- 相同告警間隔 5 分鐘內只發送一次
- 同一資料源同時只有最高級別告警
- 重複發生告警降低通知頻率
```

---

## 性能優化

### 1. 數據庫優化

```sql
-- 定期清理過期數據
DELETE FROM health_check_records
WHERE check_time < NOW() - INTERVAL '90 days';

-- 定期統計趨勢
INSERT INTO health_trends (...)
SELECT datasource_id, period_start, ... 
FROM health_check_records
GROUP BY datasource_id, period_start;

-- 分區表維護
ALTER TABLE health_check_records DETACH PARTITION health_check_records_2024_09;
DROP TABLE health_check_records_2024_09;
```

### 2. 緩存策略

```
推薦配置:
- 檢測結果緩存: 5 分鐘
- 趨勢數據緩存: 1 小時
- 告警規則緩存: 24 小時
- 健康統計緩存: 1 小時
```

### 3. 並行檢測

```python
# 推薦：檢測批次大小
batch_size = 10  # 同時檢測 10 個資料源

# 檢測優先級
priority = {
    'critical': 1,  # 優先檢測
    'error': 2,
    'warning': 3,
    'healthy': 4    # 最後檢測
}
```

---

## 常見問題

### 1. 誤報率高

**原因**:
- 網絡抖動引起超時
- DNS 解析緩存不當
- CDN 導致 IP 變化

**解決**:
- 增加重試次數
- 調整超時時間
- 使用多地點檢測

### 2. 檢測延遲

**原因**:
- 檢測任務堆積
- 網絡連接慢
- 檢測項目過多

**解決**:
- 增加檢測服務器
- 使用異步檢測
- 分離不同檢測層級

### 3. 告警風暴

**原因**:
- 規則過於敏感
- 級聯故障
- 通知渠道堵塞

**解決**:
- 實施告警抑制
- 增加去重邏輯
- 優化通知方式

---

## 相關文件引用

- **核心監測**: [代碼示例 - 健康監測](../ch3-code-examples/ch3-code-01-health-monitor.md)
- **告警系統**: [代碼示例 - 告警系統](../ch3-code-examples/ch3-code-02-alert-system.md)
- **API 文檔**: [代碼示例 - API 端點](../ch3-code-examples/ch3-code-04-api-examples.md)

---

**[← 返回第3章首頁](ch3-index.md)**
