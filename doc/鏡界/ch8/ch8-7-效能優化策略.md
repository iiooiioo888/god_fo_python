# ç¬¬8ç« ï¼šåˆ†å¸ƒå¼çˆ¬èŸ²é›†ç¾¤ç®¡ç†ç³»çµ± (Distributed Crawler Cluster Management System)

## 8.7 æ•ˆèƒ½å„ªåŒ–ç­–ç•¥

**[â† è¿”å›ç¬¬8ç« é¦–é ](ch8-index.md)**

---

#### 8.7.1 ä»»å‹™è°ƒåº¦å„ªåŒ–

1. **åˆ†å±‚ä»»å‹™éšŠåˆ—**
   ```python
   class LayeredTaskQueue:
       """åˆ†å±‚ä»»å‹™éšŠåˆ—ï¼Œæ”¯æ´ä¼˜å…ˆçº§å’Œåˆ†é¡"""
       
       def __init__(self, config: Config):
           self.config = config
           self.logger = logging.getLogger(__name__)
           
           # åˆ›å»ºä¼˜å…ˆçº§éšŠåˆ—
           self.priority_queues = {
               priority: PriorityQueue()
               for priority in range(1, 11)  # 1-10ä¼˜å…ˆçº§
           }
           
           # åˆ›å»ºç±»åˆ«éšŠåˆ—
           self.category_queues = defaultdict(PriorityQueue)
       
       def add_task(self, task: CrawlerTask):
           """æ·»åŠ ä»»å‹™åˆ°éšŠåˆ—"""
           # æŒ‰ä¼˜å…ˆçº§æ·»åŠ 
           self.priority_queues[task.priority].put((task.created_at, task.id, task))
           
           # æŒ‰ç±»åˆ«æ·»åŠ 
           for category in task.categories:
               self.category_queues[category].put((task.priority, task.created_at, task.id, task))
       
       def get_next_task(
           self,
           max_priority: int = 10,
           categories: Optional[List[str]] = None
       ) -> Optional[CrawlerTask]:
           """ç²å–ä¸‹ä¸€å€‹ä»»å‹™"""
           # 1. æŒ‰ç±»åˆ«ç²å–ä»»å‹™
           if categories:
               for category in categories:
                   if category in self.category_queues:
                       task = self._get_task_from_category_queue(category)
                       if task and task.priority <= max_priority:
                           return task
           
           # 2. æŒ‰ä¼˜å…ˆçº§ç²å–ä»»å‹™
           for priority in range(1, max_priority + 1):
               if not self.priority_queues[priority].empty():
                   _, _, task = self.priority_queues[priority].get()
                   return task
           
           return None
       
       def _get_task_from_category_queue(self, category: str) -> Optional[CrawlerTask]:
           """å¾ç±»åˆ«éšŠåˆ—ç²å–ä»»å‹™"""
           if self.category_queues[category].empty():
               return None
           
           # ç²å–æœ€é«˜ä¼˜å…ˆçº§ä»»å‹™
           _, _, _, task = self.category_queues[category].get()
           return task
       
       def task_completed(self, task: CrawlerTask):
           """ä»»å‹™å®Œæˆè™•ç†"""
           # å¾éšŠåˆ—ä¸­ç§»é™¤
           self._remove_from_priority_queue(task)
           self._remove_from_category_queues(task)
       
       def _remove_from_priority_queue(self, task: CrawlerTask):
           """å¾ä¼˜å…ˆçº§éšŠåˆ—ç§»é™¤"""
           # ç®€å•å¯¦ç¾ï¼šé‡å»ºéšŠåˆ—
           temp_queue = PriorityQueue()
           while not self.priority_queues[task.priority].empty():
               t = self.priority_queues[task.priority].get()
               if t[2].id != task.id:
                   temp_queue.put(t)
           self.priority_queues[task.priority] = temp_queue
       
       def _remove_from_category_queues(self, task: CrawlerTask):
           """å¾ç±»åˆ«éšŠåˆ—ç§»é™¤"""
           for category in task.categories:
               if category in self.category_queues:
                   # é‡å»ºç±»åˆ«éšŠåˆ—
                   temp_queue = PriorityQueue()
                   while not self.category_queues[category].empty():
                       t = self.category_queues[category].get()
                       if t[3].id != task.id:
                           temp_queue.put(t)
                   self.category_queues[category] = temp_queue
   ```

2. **æ‰¹é‡ä»»å‹™åˆ†é…**
   ```python
   class BatchTaskScheduler:
       """æ‰¹é‡ä»»å‹™è°ƒåº¦å™¨ï¼Œæé«˜è°ƒåº¦æ•ˆç‡"""
       
       def __init__(self, config: Config, node_manager: CrawlerNodeManager):
           self.config = config
           self.node_manager = node_manager
           self.logger = logging.getLogger(__name__)
       
       def schedule_batch(
           self,
           tasks: List[CrawlerTask],
           nodes: List[NodeInfo]
       ) -> Dict[str, List[CrawlerTask]]:
           """
           æ‰¹é‡è°ƒåº¦ä»»å‹™
           
           :param tasks: ä»»å‹™åˆ—è¡¨
           :param nodes: å¯ç”¨ç¯€ç‚¹åˆ—è¡¨
           :return: ç¯€ç‚¹åˆ°ä»»å‹™çš„æ˜ å°„
           """
           # 1. æŒ‰ç­–ç•¥å°ä»»å‹™æ’åº
           sorted_tasks = self._sort_tasks(tasks)
           
           # 2. æŒ‰èƒ½åŠ›å°ç¯€ç‚¹æ’åº
           sorted_nodes = self._sort_nodes(nodes)
           
           # 3. åˆ†é…ä»»å‹™
           assignment = {node.id: [] for node in sorted_nodes}
           node_index = 0
           
           for task in sorted_tasks:
               # é€‰æ‹©ç¯€ç‚¹ï¼ˆè½®è¯¢ï¼‰
               node = sorted_nodes[node_index]
               assignment[node.id].append(task)
               
               # æ›´æ–°ç´¢å¼•
               node_index = (node_index + 1) % len(sorted_nodes)
           
           return assignment
       
       def _sort_tasks(self, tasks: List[CrawlerTask]) -> List[CrawlerTask]:
           """å°ä»»å‹™æ’åº"""
           # æŒ‰ä¼˜å…ˆçº§å’Œåˆ›å»ºæ™‚é–“æ’åº
           return sorted(
               tasks,
               key=lambda t: (-t.priority, t.created_at)
           )
       
       def _sort_nodes(self, nodes: List[NodeInfo]) -> List[NodeInfo]:
           """å°ç¯€ç‚¹æ’åº"""
           # æŒ‰è´Ÿè½½æ’åºï¼ˆå‡åºï¼‰
           return sorted(
               nodes,
               key=lambda n: n.load
           )
   ```

#### 8.7.2 è³‡æºå„ªåŒ–

1. **å‹•æ€è³‡æºåˆ†é…**
   ```python
   class DynamicResourceAllocator:
       """å‹•æ€è³‡æºåˆ†é…å™¨"""
       
       def __init__(self, config: Config):
           self.config = config
           self.logger = logging.getLogger(__name__)
       
       def allocate_resources(
           self,
           task: CrawlerTask,
           node: NodeInfo
       ) -> Dict[str, Any]:
           """
           åˆ†é…è³‡æºçµ¦ä»»å‹™
           
           :param task: ä»»å‹™
           :param node: ç¯€ç‚¹
           :return: è³‡æºåˆ†é…ç»“æœ
           """
           # 1. åŸºå§‹åˆ†é…
           allocation = self._initial_allocation(task, node)
           
           # 2. æ ¹æ“šå¯¦æ™‚è´Ÿè½½è°ƒæ•´
           allocation = self._adjust_for_load(allocation, node)
           
           # 3. æ ¹æ“šä»»å‹™ç‰¹æ€§è°ƒæ•´
           allocation = self._adjust_for_task(allocation, task)
           
           return allocation
       
       def _initial_allocation(
           self,
           task: CrawlerTask,
           node: NodeInfo
       ) -> Dict[str, Any]:
           """åˆå§‹è³‡æºåˆ†é…"""
           # åŸºå§‹åˆ†é…åŸºæ–¼ä»»å‹™è¯·æ±‚
           allocation = {
               "cpu_cores": min(task.min_resources.get("cpu_cores", 1), node.resources["cpu"]),
               "memory_mb": min(task.min_resources.get("memory_mb", 1024), node.resources["memory_mb"]),
               "gpu": min(task.min_resources.get("gpu", 0), node.resources["gpu"])
           }
           
           # ç¢ºä¿è‡³å°‘åˆ†é…æœ€å°è³‡æº
           allocation["cpu_cores"] = max(allocation["cpu_cores"], 0.5)
           allocation["memory_mb"] = max(allocation["memory_mb"], 512)
           
           return allocation
       
       def _adjust_for_load(
           self,
           allocation: Dict[str, Any],
           node: NodeInfo
       ) -> Dict[str, Any]:
           """æ ¹æ“šç¯€ç‚¹è´Ÿè½½è°ƒæ•´è³‡æºåˆ†é…"""
           # å¦‚æœç¯€ç‚¹è´Ÿè½½é«˜ï¼Œå‡å°‘è³‡æºåˆ†é…
           if node.load > 0.7:
               allocation["cpu_cores"] *= 0.8
               allocation["memory_mb"] *= 0.9
           
           # å¦‚æœç¯€ç‚¹è´Ÿè½½ä½ï¼Œå¢åŠ è³‡æºåˆ†é…
           elif node.load < 0.3:
               allocation["cpu_cores"] = min(allocation["cpu_cores"] * 1.2, node.resources["cpu"])
               allocation["memory_mb"] = min(allocation["memory_mb"] * 1.1, node.resources["memory_mb"])
           
           return allocation
       
       def _adjust_for_task(
           self,
           allocation: Dict[str, Any],
           task: CrawlerTask
       ) -> Dict[str, Any]:
           """æ ¹æ“šä»»å‹™ç‰¹æ€§è°ƒæ•´è³‡æºåˆ†é…"""
           # å¦‚æœä»»å‹™éœ€è¦JavaScriptæ¸²æŸ“ï¼Œå¢åŠ å†…å­˜
           if task.capabilities.get("javascript_rendering", 0) > 0:
               allocation["memory_mb"] = min(allocation["memory_mb"] * 1.5, 8192)
           
           # å¦‚æœä»»å‹™éœ€è¦ä»£ç†è½®æ¢ï¼Œå¢åŠ CPU
           if task.capabilities.get("proxy_rotation", 0) > 0:
               allocation["cpu_cores"] = min(allocation["cpu_cores"] * 1.3, 4.0)
           
           return allocation
   ```

---

## ğŸ“‘ ç›¸é—œç« ç¯€

| å‰åº | ç•¶å‰ | å¾ŒçºŒ |
|-----|------|------|
| [8.6 APIè©³ç´°è¦ç¯„](ch8-6-APIè©³ç´°è¦ç¯„.md) | **8.7 æ•ˆèƒ½å„ªåŒ–ç­–ç•¥** | [8.8 å®‰å…¨è€ƒæ…®](ch8-8-å®‰å…¨è€ƒæ…®.md) |

**å¿«é€Ÿéˆæ¥ï¼š**
- [8.6 APIè©³ç´°è¦ç¯„](ch8-6-APIè©³ç´°è¦ç¯„.md)
- [8.8 å®‰å…¨è€ƒæ…®](ch8-8-å®‰å…¨è€ƒæ…®.md)
- [â† è¿”å›ç¬¬8ç« é¦–é ](ch8-index.md)
