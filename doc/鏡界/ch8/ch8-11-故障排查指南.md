# ç¬¬8ç« ï¼šåˆ†å¸ƒå¼çˆ¬èŸ²é›†ç¾¤ç®¡ç†ç³»çµ±

## 8.11 æ•…éšœæ’æŸ¥æŒ‡å—

**[â† è¿”å›ç¬¬8ç« é¦–é ](ch8-index.md)**

---

## ğŸ› å¸¸è¦‹å•é¡Œ

### å•é¡Œ 1: çˆ¬èŸ²ç¯€é»é »ç¹é›¢ç·š

#### ç—‡ç‹€
- ç¯€é»ç‹€æ…‹ä¸ç©©å®š
- ä»»å‹™åŸ·è¡Œå¤±æ•—ç‡é«˜
- ç¯€é»å¿ƒè·³è¶…æ™‚

#### è¨ºæ–·æ­¥é©Ÿ

```python
# ç¯€é»å¥åº·è¨ºæ–·å·¥å…·
class NodeHealthDiagnostics:
    """ç¯€é»å¥åº·è¨ºæ–·"""
    
    def diagnose_node(self, node_id: str) -> Dict:
        """è¨ºæ–·ç¯€é»å•é¡Œ"""
        node = self.get_node(node_id)
        
        diagnostics = {
            'node_id': node_id,
            'issues': [],
            'metrics': {},
            'suggestions': []
        }
        
        # æª¢æŸ¥è³‡æºä½¿ç”¨
        if node.cpu_usage > 90:
            diagnostics['issues'].append("CPUä½¿ç”¨ç‡éé«˜")
            diagnostics['suggestions'].append("æ¸›å°‘ä¸¦ç™¼ä»»å‹™æ•¸æˆ–å‡ç´šç¡¬é«”")
        
        if node.memory_usage > 85:
            diagnostics['issues'].append("è¨˜æ†¶é«”ä½¿ç”¨ç‡éé«˜")
            diagnostics['suggestions'].append("å¢åŠ è¨˜æ†¶é«”æˆ–å„ªåŒ–çˆ¬èŸ²ä»£ç¢¼")
        
        # æª¢æŸ¥ç¶²è·¯é€£æ¥
        if node.network_errors > 100:
            diagnostics['issues'].append("ç¶²è·¯éŒ¯èª¤éå¤š")
            diagnostics['suggestions'].append("æª¢æŸ¥ç¶²è·¯é…ç½®å’Œä»£ç†è¨­ç½®")
        
        # æª¢æŸ¥å¿ƒè·³å»¶é²
        if node.heartbeat_latency > 5000:  # 5ç§’
            diagnostics['issues'].append("å¿ƒè·³å»¶é²éé«˜")
            diagnostics['suggestions'].append("æª¢æŸ¥ç¶²è·¯é€£æ¥å’Œç¯€é»è² è¼‰")
        
        return diagnostics
```

#### è§£æ±ºæ–¹æ¡ˆ

```python
class RobustNodeManager:
    """å¥å£¯çš„ç¯€é»ç®¡ç†å™¨"""
    
    def __init__(self):
        self.heartbeat_timeout = 30  # 30ç§’
        self.max_retries = 3
        self.backoff_multiplier = 2
    
    def handle_node_failure(self, node_id: str):
        """è™•ç†ç¯€é»æ•…éšœ"""
        node = self.get_node(node_id)
        
        # 1. é‡æ–°åˆ†é…ä»»å‹™
        tasks = self.get_node_tasks(node_id)
        self.redistribute_tasks(tasks)
        
        # 2. å˜—è©¦é‡å•Ÿç¯€é»
        if self.can_restart(node):
            self.restart_node(node_id)
        
        # 3. æ¨™è¨˜ç¯€é»ç‚ºä¸å¯ç”¨
        else:
            self.mark_node_unavailable(node_id)
            self.notify_admin(node_id, "Node failure")
    
    def redistribute_tasks(self, tasks: List[Task]):
        """é‡æ–°åˆ†é…ä»»å‹™"""
        available_nodes = self.get_available_nodes()
        
        for task in tasks:
            # é¸æ“‡è² è¼‰æœ€ä½çš„ç¯€é»
            target_node = min(available_nodes, key=lambda n: n.current_load)
            self.assign_task(task, target_node)
```

---

### å•é¡Œ 2: çˆ¬å–é€Ÿåº¦æ…¢

#### ç—‡ç‹€
- æ¯ç§’è«‹æ±‚æ•¸(RPS)ä½æ–¼é æœŸ
- ä»»å‹™å®Œæˆæ™‚é–“éé•·
- ç³»çµ±è³‡æºä½¿ç”¨ç‡ä½

#### è§£æ±ºæ–¹æ¡ˆ

```python
class PerformanceOptimizer:
    """æ•ˆèƒ½å„ªåŒ–å™¨"""
    
    def optimize_crawler_config(self, node: Node) -> Dict:
        """å„ªåŒ–çˆ¬èŸ²é…ç½®"""
        config = node.config.copy()
        
        # å‹•æ…‹èª¿æ•´ä¸¦ç™¼æ•¸
        if node.cpu_usage < 50 and node.memory_usage < 70:
            config['concurrent_requests'] = min(
                config['concurrent_requests'] * 1.5,
                100  # æœ€å¤§å€¼
            )
        elif node.cpu_usage > 80 or node.memory_usage > 85:
            config['concurrent_requests'] = max(
                config['concurrent_requests'] * 0.7,
                10  # æœ€å°å€¼
            )
        
        # èª¿æ•´è«‹æ±‚å»¶é²
        if node.error_rate < 0.01:  # éŒ¯èª¤ç‡ä½æ–¼1%
            config['download_delay'] = max(config['download_delay'] * 0.8, 0.1)
        elif node.error_rate > 0.1:
            config['download_delay'] = min(config['download_delay'] * 1.5, 5)
        
        return config
```

---

### å•é¡Œ 3: åçˆ¬èŸ²å°é–

#### ç—‡ç‹€
- å¤§é‡ 403/429 éŒ¯èª¤
- IP è¢«å°é–
- é©—è­‰ç¢¼é »ç¹å‡ºç¾

#### è§£æ±ºæ–¹æ¡ˆ

```python
class AntiBlockingStrategy:
    """åå°é–ç­–ç•¥"""
    
    def __init__(self):
        self.proxy_pool = ProxyPool()
        self.user_agent_rotator = UserAgentRotator()
    
    def get_request_config(self, url: str, retry_count: int = 0) -> Dict:
        """ç²å–è«‹æ±‚é…ç½®ï¼ˆåå°é–ï¼‰"""
        config = {
            'headers': self._get_headers(retry_count),
            'proxies': self._get_proxy(retry_count),
            'timeout': self._get_timeout(retry_count),
            'delay': self._get_delay(retry_count)
        }
        
        return config
    
    def _get_headers(self, retry_count: int) -> Dict:
        """ç²å–è«‹æ±‚é ­"""
        headers = {
            'User-Agent': self.user_agent_rotator.get_random(),
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
            'Accept-Language': 'en-US,en;q=0.5',
            'Accept-Encoding': 'gzip, deflate',
            'Connection': 'keep-alive',
            'Upgrade-Insecure-Requests': '1'
        }
        
        # é‡è©¦æ™‚æ·»åŠ æ›´å¤šå½è£
        if retry_count > 0:
            headers['Referer'] = 'https://www.google.com/'
            headers['DNT'] = '1'
        
        return headers
    
    def _get_proxy(self, retry_count: int) -> Dict:
        """ç²å–ä»£ç†"""
        if retry_count == 0:
            return None  # ç¬¬ä¸€æ¬¡å˜—è©¦ä¸ç”¨ä»£ç†
        
        # å¾ä»£ç†æ± ç²å–
        proxy = self.proxy_pool.get_random()
        return {
            'http': proxy,
            'https': proxy
        }
    
    def _get_delay(self, retry_count: int) -> float:
        """ç²å–å»¶é²æ™‚é–“"""
        base_delay = 1
        return base_delay * (2 ** retry_count) + random.uniform(0, 1)
```

---

## ğŸ“Š æ•ˆèƒ½ç›£æ§

```python
class CrawlerMetricsCollector:
    """çˆ¬èŸ²æŒ‡æ¨™æ”¶é›†å™¨"""
    
    def collect_metrics(self) -> Dict:
        """æ”¶é›†æŒ‡æ¨™"""
        return {
            'total_nodes': self.count_total_nodes(),
            'active_nodes': self.count_active_nodes(),
            'total_tasks': self.count_total_tasks(),
            'completed_tasks': self.count_completed_tasks(),
            'failed_tasks': self.count_failed_tasks(),
            'avg_task_duration': self.calculate_avg_duration(),
            'requests_per_second': self.calculate_rps(),
            'error_rate': self.calculate_error_rate(),
            'bandwidth_usage': self.get_bandwidth_usage()
        }
```

---

**ç›¸é—œç« ç¯€**:
- [8.7 æ•ˆèƒ½å„ªåŒ–ç­–ç•¥](ch8-7-æ•ˆèƒ½å„ªåŒ–ç­–ç•¥.md)
- [â† è¿”å›ç¬¬8ç« é¦–é ](ch8-index.md)

