# ç¬¬9ç« ï¼šç³»çµ±æ•´åˆèˆ‡éƒ¨ç½²

## 9.15 å®‰å…¨èˆ‡åˆè¦

**[â† è¿”å›ç¬¬9ç« é¦–é ](ch9-index.md)**

---

#### 9.15.1 å®‰å…¨ç­–ç•¥

1. **ç¶²è·¯éš”é›¢ç­–ç•¥**
   ```yaml
   # network-policy.yaml
   apiVersion: networking.k8s.io/v1
   kind: NetworkPolicy
   metadata:
     name: mirror-realm-network-policy
   spec:
     podSelector: {}
     policyTypes:
     - Ingress
     - Egress
     ingress:
     - from:
       - namespaceSelector:
           matchLabels:
             project: mirror-realm
         podSelector:
           matchLabels:
             app: api-gateway
       ports:
       - protocol: TCP
         port: 8000
     egress:
     - to:
       - namespaceSelector:
           matchLabels:
             project: mirror-realm
         podSelector:
           matchLabels:
             app: postgres
       ports:
       - protocol: TCP
         port: 5432
     - to:
       - namespaceSelector:
           matchLabels:
             project: mirror-realm
         podSelector:
           matchLabels:
             app: redis
       ports:
       - protocol: TCP
         port: 6379
   ```

2. **å®‰å…¨æƒæç­–ç•¥**
   ```yaml
   # security-scan.yaml
   apiVersion: batch/v1
   kind: CronJob
   metadata:
     name: security-scan
   spec:
     schedule: "0 2 * * *"
     jobTemplate:
       spec:
         template:
           spec:
             containers:
             - name: trivy
               image: aquasec/trivy:0.16.0
               command: ["trivy"]
               args: 
                 - "--severity", "CRITICAL,HIGH"
                 - "kubernetes"
                 - "--format", "table"
                 - "--exit-code", "1"
               volumeMounts:
               - name: kubeconfig
                 mountPath: /root/.kube
             volumes:
             - name: kubeconfig
               secret:
                 secretName: kubeconfig
             restartPolicy: OnFailure
   ```

#### 9.15.2 åˆè¦æ€§æª¢æŸ¥

1. **è‡ªå‹•åŒ–åˆè¦å·¥ä½œæµ**
   ```python
   class ComplianceWorkflow:
       """è‡ªå‹•åŒ–åˆè¦å·¥ä½œæµ"""
       
       def __init__(
           self,
           compliance_service: ComplianceService,
           notification_service: NotificationService,
           config: Config
       ):
           self.compliance_service = compliance_service
           self.notification_service = notification_service
           self.config = config
           self.logger = logging.getLogger(__name__)
       
       def run_daily_check(self):
           """åŸ·è¡Œæ¯æ—¥åˆè¦æ€§æª¢æŸ¥"""
           # 1. ç²å–æ‰€æœ‰æ´»èºè³‡æ–™æº
           data_sources = self.compliance_service.get_active_data_sources()
           
           # 2. æª¢æŸ¥æ¯å€‹è³‡æ–™æº
           non_compliant_sources = []
           for ds in data_sources:
               result = self.compliance_service.check_compliance(ds)
               if result.status != "compliant":
                   non_compliant_sources.append((ds, result))
           
           # 3. ç”Ÿæˆå ±å‘Š
           report = self._generate_report(non_compliant_sources)
           
           # 4. ç™¼é€é€šçŸ¥
           self._send_notifications(report)
           
           # 5. è¿½è¹¤å•é¡Œ
           self._track_issues(non_compliant_sources)
       
       def _generate_report(self, non_compliant_sources: List) -> ComplianceReport:
           """ç”Ÿæˆåˆè¦æ€§å ±å‘Š"""
           return ComplianceReport(
               date=datetime.utcnow(),
               total_sources=len(data_sources),
               compliant_count=len(data_sources) - len(non_compliant_sources),
               non_compliant_count=len(non_compliant_sources),
               critical_issues=sum(1 for _, r in non_compliant_sources if r.critical_issues > 0),
               details=non_compliant_sources
           )
       
       def _send_notifications(self, report: ComplianceReport):
           """ç™¼é€é€šçŸ¥"""
           # ç™¼é€çµ¦åˆè¦åœ˜éšŠ
           self.notification_service.send_email(
               to=self.config.compliance_team_email,
               subject=f"Daily Compliance Report - {report.date.strftime('%Y-%m-%d')}",
               body=self._format_report_email(report)
           )
           
           # å¦‚æœæœ‰é—œéµå•é¡Œï¼Œç™¼é€è­¦å ±
           if report.critical_issues > 0:
               self.notification_service.send_slack_alert(
                   channel=self.config.alert_channel,
                   message=f"Critical compliance issues detected! {report.critical_issues} sources affected."
               )
       
       def _track_issues(self, non_compliant_sources: List):
           """è¿½è¹¤åˆè¦æ€§å•é¡Œ"""
           for ds, result in non_compliant_sources:
               # å‰µå»ºæˆ–æ›´æ–°å•é¡Œ
               issue = self.compliance_service.get_issue(ds.id)
               if not issue:
                   self.compliance_service.create_issue(
                       data_source_id=ds.id,
                       description=result.suggestions[0] if result.suggestions else "Non-compliant data source",
                       severity="critical" if result.critical_issues > 0 else "high",
                       due_date=datetime.utcnow() + timedelta(days=7)
                   )
               else:
                   # æ›´æ–°ç¾æœ‰å•é¡Œ
                   self.compliance_service.update_issue(
                       issue.id,
                       status="open",
                       last_checked=datetime.utcnow()
                   )
   ```

---

## ğŸ“‘ ç›¸é—œç« ç¯€

| å‰åº | ç•¶å‰ | å¾ŒçºŒ |
|-----|------|------|
| [9.14 æŒçºŒæ•´åˆèˆ‡æŒçºŒéƒ¨ç½²](ch9-14-æŒçºŒæ•´åˆèˆ‡æŒçºŒéƒ¨ç½².md) | **9.15 å®‰å…¨èˆ‡åˆè¦** | [9.16 æ•ˆèƒ½æ¸¬è©¦æ–¹æ¡ˆ](ch9-16-æ•ˆèƒ½æ¸¬è©¦æ–¹æ¡ˆ.md) |

**å¿«é€Ÿéˆæ¥ï¼š**
- [9.14 æŒçºŒæ•´åˆèˆ‡æŒçºŒéƒ¨ç½²](ch9-14-æŒçºŒæ•´åˆèˆ‡æŒçºŒéƒ¨ç½².md)
- [9.16 æ•ˆèƒ½æ¸¬è©¦æ–¹æ¡ˆ](ch9-16-æ•ˆèƒ½æ¸¬è©¦æ–¹æ¡ˆ.md)
- [â† è¿”å›ç¬¬9ç« é¦–é ](ch9-index.md)

