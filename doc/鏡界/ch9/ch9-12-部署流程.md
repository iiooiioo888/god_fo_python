# ç¬¬9ç« ï¼šç³»çµ±æ•´åˆèˆ‡éƒ¨ç½²

## 9.12 éƒ¨ç½²æµç¨‹

**[â† è¿”å›ç¬¬9ç« é¦–é ](ch9-index.md)**

---

#### 9.12.1 åŸºç¤è¨­æ–½æº–å‚™

1. **é›²è³‡æºæº–å‚™**
   ```bash
   # å‰µå»ºVPCç¶²è·¯
   aws ec2 create-vpc --cidr-block 10.0.0.0/16
   
   # å‰µå»ºå­ç¶²
   aws ec2 create-subnet --vpc-id vpc-123 --cidr-block 10.0.1.0/24 --availability-zone us-east-1a
   
   # å‰µå»ºå®‰å…¨çµ„
   aws ec2 create-security-group --group-name mirror-realm-sg --description "Mirror Realm Security Group"
   
   # é…ç½®å®‰å…¨çµ„è¦å‰‡
   aws ec2 authorize-security-group-ingress --group-id sg-123 --protocol tcp --port 80 --cidr 0.0.0.0/0
   aws ec2 authorize-security-group-ingress --group-id sg-123 --protocol tcp --port 443 --cidr 0.0.0.0/0
   aws ec2 authorize-security-group-ingress --group-id sg-123 --protocol tcp --port 8000-9000 --cidr 10.0.0.0/16
   ```

2. **Kubernetesé›†ç¾¤å‰µå»º**
   ```bash
   # å‰µå»ºEKSé›†ç¾¤
   eksctl create cluster \
     --name mirror-realm-prod \
     --region us-east-1 \
     --nodegroup-name standard-workers \
     --node-type t3.xlarge \
     --nodes 3 \
     --nodes-min 3 \
     --nodes-max 10 \
     --node-ami auto
   ```

#### 9.12.2 æœå‹™éƒ¨ç½²

1. **è³‡æ–™åº«éƒ¨ç½²**
   ```yaml
   # postgres-deployment.yaml
   apiVersion: apps/v1
   kind: StatefulSet
   metadata:
     name: postgres
   spec:
     serviceName: postgres
     replicas: 3
     selector:
       matchLabels:
         app: postgres
     template:
       metadata:
         labels:
           app: postgres
       spec:
         containers:
         - name: postgres
           image: postgres:13
           env:
           - name: POSTGRES_USER
             value: "mirror_realm"
           - name: POSTGRES_PASSWORD
             valueFrom:
               secretKeyRef:
                 name: db-secrets
                 key: password
           - name: POSTGRES_DB
             value: "mirror_realm"
           ports:
           - containerPort: 5432
           volumeMounts:
           - name: data
             mountPath: /var/lib/postgresql/data
         volumes:
         - name: data
           persistentVolumeClaim:
             claimName: postgres-pvc
   ---
   apiVersion: v1
   kind: Service
   metadata:
     name: postgres
   spec:
     ports:
     - port: 5432
       targetPort: 5432
     clusterIP: None
     selector:
       app: postgres
   ```

2. **å¾®æœå‹™éƒ¨ç½²**
   ```yaml
   # dsr-deployment.yaml
   apiVersion: apps/v1
   kind: Deployment
   metadata:
     name: data-source-registry
   spec:
     replicas: 3
     selector:
       matchLabels:
         app: data-source-registry
     template:
       metadata:
         labels:
           app: data-source-registry
       spec:
         containers:
         - name: dsr
           image: mirror-realm/dsr:1.0.0
           ports:
           - containerPort: 8000
           env:
           - name: DB_HOST
             value: "postgres"
           - name: DB_PORT
             value: "5432"
           - name: DB_NAME
             value: "mirror_realm"
           - name: DB_USER
             value: "mirror_realm"
           - name: DB_PASSWORD
             valueFrom:
               secretKeyRef:
                 name: db-secrets
                 key: password
           resources:
             requests:
               memory: "512Mi"
               cpu: "500m"
             limits:
               memory: "1Gi"
               cpu: "1000m"
   ---
   apiVersion: v1
   kind: Service
   metadata:
     name: data-source-registry
   spec:
     type: ClusterIP
     ports:
     - port: 80
       targetPort: 8000
     selector:
       app: data-source-registry
   ```

#### 9.12.3 é…ç½®ç®¡ç†

1. **é…ç½®æ–‡ä»¶çµæ§‹**
   ```
   config/
   â”œâ”€â”€ base/
   â”‚   â”œâ”€â”€ application.yaml
   â”‚   â”œâ”€â”€ database.yaml
   â”‚   â””â”€â”€ security.yaml
   â”œâ”€â”€ dev/
   â”‚   â”œâ”€â”€ application.yaml
   â”‚   â””â”€â”€ overrides.yaml
   â”œâ”€â”€ staging/
   â”‚   â”œâ”€â”€ application.yaml
   â”‚   â””â”€â”€ overrides.yaml
   â””â”€â”€ prod/
       â”œâ”€â”€ application.yaml
       â””â”€â”€ overrides.yaml
   ```

2. **é…ç½®ç®¡ç†æœå‹™å¯¦ç¾**
   ```python
   import os
   import yaml
   from typing import Dict, Any
   import logging

   class ConfigManager:
       """é…ç½®ç®¡ç†å™¨ï¼Œè¼‰å…¥å’Œç®¡ç†æ‡‰ç”¨é…ç½®"""
       
       def __init__(self, env: str = "prod"):
           self.env = env
           self.logger = logging.getLogger(__name__)
           self.config = self._load_config()
       
       def _load_config(self) -> Dict[str, Any]:
           """è¼‰å…¥é…ç½®"""
           # 1. è¼‰å…¥åŸºç¤é…ç½®
           base_config = self._load_yaml("config/base/application.yaml")
           
           # 2. è¼‰å…¥ç’°å¢ƒç‰¹å®šé…ç½®
           env_config = self._load_yaml(f"config/{self.env}/application.yaml")
           
           # 3. è¼‰å…¥è¦†è“‹é…ç½®
           overrides = self._load_yaml(f"config/{self.env}/overrides.yaml")
           
           # 4. åˆä½µé…ç½®
           config = self._deep_merge(base_config, env_config)
           config = self._deep_merge(config, overrides)
           
           # 5. å¾ç’°å¢ƒè®Šæ•¸è¦†è“‹
           config = self._apply_env_overrides(config)
           
           return config
       
       def _load_yaml(self, path: str) -> Dict:
           """è¼‰å…¥YAMLæ–‡ä»¶"""
           if not os.path.exists(path):
               self.logger.debug("Config file not found: %s", path)
               return {}
           
           with open(path, 'r') as f:
               return yaml.safe_load(f) or {}
       
       def _deep_merge(self, base: Dict, override: Dict) -> Dict:
           """æ·±åº¦åˆä½µé…ç½®"""
           result = base.copy()
           
           for key, value in override.items():
               if isinstance(value, dict) and key in result and isinstance(result[key], dict):
                   result[key] = self._deep_merge(result[key], value)
               else:
                   result[key] = value
           
           return result
       
       def _apply_env_overrides(self, config: Dict) -> Dict:
           """æ‡‰ç”¨ç’°å¢ƒè®Šæ•¸è¦†è“‹"""
           for key, value in os.environ.items():
               if key.startswith("APP_"):
                   # è½‰æ›ç‚ºé…ç½®è·¯å¾‘
                   config_path = key[4:].lower().replace('_', '.')
                   self._set_config_value(config, config_path, value)
           
           return config
       
       def _set_config_value(self, config: Dict, path: str, value: Any):
           """è¨­ç½®é…ç½®å€¼"""
           keys = path.split('.')
           current = config
           
           for key in keys[:-1]:
               if key not in current or not isinstance(current[key], dict):
                   current[key] = {}
               current = current[key]
           
           # è½‰æ›å€¼é¡å‹
           if isinstance(current[keys[-1]], bool):
               value = value.lower() == 'true'
           elif isinstance(current[keys[-1]], int):
               value = int(value)
           elif isinstance(current[keys[-1]], float):
               value = float(value)
           
           current[keys[-1]] = value
       
       def get(self, path: str, default: Any = None) -> Any:
           """ç²å–é…ç½®å€¼"""
           keys = path.split('.')
           current = self.config
           
           for key in keys:
               if key not in current:
                   return default
               current = current[key]
           
           return current
       
       def get_database_config(self) -> Dict:
           """ç²å–è³‡æ–™åº«é…ç½®"""
           return {
               "host": self.get("database.host", "localhost"),
               "port": self.get("database.port", 5432),
               "name": self.get("database.name", "mirror_realm"),
               "user": self.get("database.user", "mirror_realm"),
               "password": os.getenv("DB_PASSWORD", "")
           }
   ```

---

## ğŸ“‘ ç›¸é—œç« ç¯€

| å‰åº | ç•¶å‰ | å¾ŒçºŒ |
|-----|------|------|
| [9.11 éƒ¨ç½²æ¶æ§‹](ch9-11-éƒ¨ç½²æ¶æ§‹.md) | **9.12 éƒ¨ç½²æµç¨‹** | [9.13 ç›£æ§èˆ‡å‘Šè­¦](ch9-13-ç›£æ§èˆ‡å‘Šè­¦.md) |

**å¿«é€Ÿéˆæ¥ï¼š**
- [9.11 éƒ¨ç½²æ¶æ§‹](ch9-11-éƒ¨ç½²æ¶æ§‹.md)
- [9.13 ç›£æ§èˆ‡å‘Šè­¦](ch9-13-ç›£æ§èˆ‡å‘Šè­¦.md)
- [â† è¿”å›ç¬¬9ç« é¦–é ](ch9-index.md)

