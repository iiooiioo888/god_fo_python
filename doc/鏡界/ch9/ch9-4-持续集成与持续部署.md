# 第9章：系統整合與部署

## 9.4 持續整合與持續部署

**[← 返回第9章首頁](ch9-index.md)**

---

#### 9.4.1 CI/CD流水线

```
┌───────────────────────────────────────────────────────────────────────────────────────────────┐
│                                     CI/CD流水线設計                                         │
├───────────────────────┬───────────────────────┬───────────────────────────────────────────────┤
│  代码阶段             │  構建阶段             │  部署阶段                                  │
├───────────────────────┼───────────────────────┼───────────────────────────────────────────────┤
│ • 代码提交            │ • 代码構建            │ • 单元测试部署                             │
│ • 静设检查            │ • 单元测试            │ • 自動化测试部署                           │
│ • 代码审查            │ • 安全扫描            │ • 預产环境部署                             │
│ • 单元测试            │ • 镜镜構建            │ • 藍度发布                                 │
└───────────────────────┴───────────────────────┴───────────────────────────────────────────────┘
```

#### 9.4.2 流水线配置

1. **GitHub Actions配置示例**
   ```yaml
   # .github/workflows/ci-cd.yaml
   name: Mirror Realm CI/CD Pipeline
   
   on:
     push:
       branches: [ main ]
     pull_request:
       branches: [ main ]
   
   jobs:
     build:
       runs-on: ubuntu-latest
       steps:
       - name: Checkout code
         uses: actions/checkout@v2
       
       - name: Set up Python
         uses: actions/setup-python@v2
         with:
           python-version: '3.9'
       
       - name: Install dependencies
         run: |
           python -m pip install --upgrade pip
           pip install -r requirements.txt
       
       - name: Run unit tests
         run: pytest tests/unit --cov=src --cov-report=xml
       
       - name: Security scan
         run: bandit -r src
       
       - name: Build Docker image
         if: github.ref == 'refs/heads/main'
         run: |
           docker build -t mirror-realm/dsr:${{ github.sha }} .
           docker login -u ${{ secrets.DOCKER_USER }} -p ${{ secrets.DOCKER_PASSWORD }}
           docker push mirror-realm/dsr:${{ github.sha }}
   
     deploy-staging:
       needs: build
       runs-on: ubuntu-latest
       if: github.ref == 'refs/heads/main'
       steps:
       - name: Deploy to staging
         uses: appleboy/ssh-action@master
         with:
           host: ${{ secrets.STAGING_HOST }}
           username: ${{ secrets.STAGING_USER }}
           key: ${{ secrets.STAGING_SSH_KEY }}
           script: |
             cd /opt/mirror-realm
             git pull origin main
             docker-compose -f docker-compose.staging.yml up -d --build
   
     deploy-prod:
       needs: deploy-staging
       runs-on: ubuntu-latest
       if: github.ref == 'refs/heads/main'
       environment: production
       steps:
       - name: Manual approval
         uses: actions/github-script@v3
         with:
           script: |
             const core = require('@actions/core');
             const github = require('@actions/github');
             
             const { deployment } = await github.rest.actions.createDeployment({
               owner: context.repo.owner,
               repo: context.repo.repo,
               ref: context.ref,
               environment: 'production',
               required_contexts: []
             });
             
             core.setOutput('deployment_id', deployment.id);
       
       - name: Deploy to production
         uses: appleboy/ssh-action@master
         with:
           host: ${{ secrets.PROD_HOST }}
           username: ${{ secrets.PROD_USER }}
           key: ${{ secrets.PROD_SSH_KEY }}
           script: |
             cd /opt/mirror-realm
             git pull origin main
             docker-compose -f docker-compose.prod.yml up -d --build
   ```

#### 9.4.3 藍度发布策略

1. **藍綠部署實現**
   ```bash
   # blue-green-deploy.sh
   #!/bin/bash
   
   set -e
   
   # 參數
   SERVICE_NAME=$1
   NEW_VERSION=$2
   TRAFFIC_PERCENTAGE=${3:-0}
   
   echo "Starting blue-green deployment for $SERVICE_NAME to version $NEW_VERSION"
   
   # 1. 部署新版本（綠色环境）
   echo "Deploying new version to green environment"
   kubectl apply -f manifests/$SERVICE_NAME-green.yaml
   
   # 2. 等待新版本准備就绪
   echo "Waiting for green environment to be ready"
   kubectl rollout status deployment/$SERVICE_NAME-green
   
   # 3. 逐步切換流量
   if [ "$TRAFFIC_PERCENTAGE" -gt 0 ]; then
     echo "Shifting $TRAFFIC_PERCENTAGE% of traffic to green environment"
     kubectl patch virtualservice/$SERVICE_NAME -n istio-system -p \
       '{"spec":{"http":[{"route":[{"destination":{"host":"'$SERVICE_NAME'-green"}, "weight":'$TRAFFIC_PERCENTAGE'}]}]}}'
   else
     echo "Switching all traffic to green environment"
     kubectl patch virtualservice/$SERVICE_NAME -n istio-system -p \
       '{"spec":{"http":[{"route":[{"destination":{"host":"'$SERVICE_NAME'-green"}, "weight":100}]}]}}'
   fi
   
   # 4. 验行测试
   echo "Running smoke tests"
   ./smoke-tests.sh $SERVICE_NAME
   
   # 5. 完成切換或回滚
   if [ $? -eq 0 ]; then
     echo "Deployment successful, cleaning up old version"
     kubectl delete deployment/$SERVICE_NAME-blue
   else
     echo "Deployment failed, rolling back to blue environment"
     kubectl patch virtualservice/$SERVICE_NAME -n istio-system -p \
       '{"spec":{"http":[{"route":[{"destination":{"host":"'$SERVICE_NAME'-blue"}, "weight":100}]}]}}'
     exit 1
   fi
   ```

2. **金丝雀发布實現**
   ```bash
   # canary-release.sh
   #!/bin/bash
   
   set -e
   
   # 參數
   SERVICE_NAME=$1
   NEW_VERSION=$2
   CANARY_PERCENTAGE=${3:-5}
   INTERVAL=${4:-5}
   DURATION=${5:-30}
   
   echo "Starting canary release for $SERVICE_NAME to version $NEW_VERSION"
   
   # 1. 部署金丝雀版本
   echo "Deploying canary version"
   sed "s/{{VERSION}}/$NEW_VERSION/g" manifests/$SERVICE_NAME-canary.yaml | kubectl apply -f -
   
   # 2. 等待金丝雀版本准備就绪
   echo "Waiting for canary version to be ready"
   kubectl rollout status deployment/$SERVICE_NAME-canary
   
   # 3. 逐步增加金丝雀流量
   total_steps=$((DURATION / INTERVAL))
   for i in $(seq 1 $total_steps); do
     current_percentage=$((CANARY_PERCENTAGE * i / total_steps))
     
     echo "Shifting $current_percentage% of traffic to canary version"
     kubectl patch virtualservice/$SERVICE_NAME -n istio-system -p \
       "{\"spec\":{\"http\":[{\"route\":[{\"destination\":{\"host\":\"$SERVICE_NAME\"}, \"weight\":$((100 - current_percentage))},{\"destination\":{\"host\":\"$SERVICE_NAME-canary\"}, \"weight\":$current_percentage}]}]}}"
     
     # 檢查指標
     ./check-metrics.sh $SERVICE_NAME $current_percentage
     
     # 檢查错误率
     error_rate=$(./get-error-rate.sh $SERVICE_NAME-canary)
     if (( $(echo "$error_rate > 0.01" | bc -l) )); then
       echo "Error rate too high ($error_rate%), rolling back"
       kubectl patch virtualservice/$SERVICE_NAME -n istio-system -p \
         "{\"spec\":{\"http\":[{\"route\":[{\"destination\":{\"host\":\"$SERVICE_NAME\"}, \"weight\":100}]}]}}"
       exit 1
     fi
     
     sleep $INTERVAL
   done
   
   # 4. 完成金丝雀发布
   echo "Canary release complete, promoting to full production"
   kubectl patch virtualservice/$SERVICE_NAME -n istio-system -p \
     "{\"spec\":{\"http\":[{\"route\":[{\"destination\":{\"host\":\"$SERVICE_NAME\"}, \"weight\":0},{\"destination\":{\"host\":\"$SERVICE_NAME-canary\"}, \"weight\":100}]}]}}"
   kubectl delete deployment/$SERVICE_NAME
   kubectl rollout status deployment/$SERVICE_NAME-canary
   kubectl patch deployment/$SERVICE_NAME-canary --type='json' -p='[{"op": "replace", "path": "/metadata/name", "value":"'$SERVICE_NAME'"}]'
   ```

---

## 📑 相關章節

| 前序 | 當前 | 後續 |
|-----|------|------|
| [9.3 監控與告警](ch9-3-監控與告警.md) | **9.4 持續整合與持續部署** | [9.5 安全與合規](ch9-5-安全與合規.md) |

**快速鏈接：**
- [9.3 監控與告警](ch9-3-監控與告警.md)
- [9.5 安全與合規](ch9-5-安全與合規.md)
- [← 返回第9章首頁](ch9-index.md)
