# ç¬¬9ç« ï¼šç³»çµ±æ•´åˆèˆ‡éƒ¨ç½²

## 9.4 æŒçºŒæ•´åˆèˆ‡æŒçºŒéƒ¨ç½²

**[â† è¿”å›ç¬¬9ç« é¦–é ](ch9-index.md)**

---

#### 9.4.1 CI/CDæµæ°´çº¿

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                     CI/CDæµæ°´çº¿è¨­è¨ˆ                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä»£ç é˜¶æ®µ             â”‚  æ§‹å»ºé˜¶æ®µ             â”‚  éƒ¨ç½²é˜¶æ®µ                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ ä»£ç æäº¤            â”‚ â€¢ ä»£ç æ§‹å»º            â”‚ â€¢ å•å…ƒæµ‹è¯•éƒ¨ç½²                             â”‚
â”‚ â€¢ é™è®¾æ£€æŸ¥            â”‚ â€¢ å•å…ƒæµ‹è¯•            â”‚ â€¢ è‡ªå‹•åŒ–æµ‹è¯•éƒ¨ç½²                           â”‚
â”‚ â€¢ ä»£ç å®¡æŸ¥            â”‚ â€¢ å®‰å…¨æ‰«æ            â”‚ â€¢ é äº§ç¯å¢ƒéƒ¨ç½²                             â”‚
â”‚ â€¢ å•å…ƒæµ‹è¯•            â”‚ â€¢ é•œé•œæ§‹å»º            â”‚ â€¢ è—åº¦å‘å¸ƒ                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 9.4.2 æµæ°´çº¿é…ç½®

1. **GitHub Actionsé…ç½®ç¤ºä¾‹**
   ```yaml
   # .github/workflows/ci-cd.yaml
   name: Mirror Realm CI/CD Pipeline
   
   on:
     push:
       branches: [ main ]
     pull_request:
       branches: [ main ]
   
   jobs:
     build:
       runs-on: ubuntu-latest
       steps:
       - name: Checkout code
         uses: actions/checkout@v2
       
       - name: Set up Python
         uses: actions/setup-python@v2
         with:
           python-version: '3.9'
       
       - name: Install dependencies
         run: |
           python -m pip install --upgrade pip
           pip install -r requirements.txt
       
       - name: Run unit tests
         run: pytest tests/unit --cov=src --cov-report=xml
       
       - name: Security scan
         run: bandit -r src
       
       - name: Build Docker image
         if: github.ref == 'refs/heads/main'
         run: |
           docker build -t mirror-realm/dsr:${{ github.sha }} .
           docker login -u ${{ secrets.DOCKER_USER }} -p ${{ secrets.DOCKER_PASSWORD }}
           docker push mirror-realm/dsr:${{ github.sha }}
   
     deploy-staging:
       needs: build
       runs-on: ubuntu-latest
       if: github.ref == 'refs/heads/main'
       steps:
       - name: Deploy to staging
         uses: appleboy/ssh-action@master
         with:
           host: ${{ secrets.STAGING_HOST }}
           username: ${{ secrets.STAGING_USER }}
           key: ${{ secrets.STAGING_SSH_KEY }}
           script: |
             cd /opt/mirror-realm
             git pull origin main
             docker-compose -f docker-compose.staging.yml up -d --build
   
     deploy-prod:
       needs: deploy-staging
       runs-on: ubuntu-latest
       if: github.ref == 'refs/heads/main'
       environment: production
       steps:
       - name: Manual approval
         uses: actions/github-script@v3
         with:
           script: |
             const core = require('@actions/core');
             const github = require('@actions/github');
             
             const { deployment } = await github.rest.actions.createDeployment({
               owner: context.repo.owner,
               repo: context.repo.repo,
               ref: context.ref,
               environment: 'production',
               required_contexts: []
             });
             
             core.setOutput('deployment_id', deployment.id);
       
       - name: Deploy to production
         uses: appleboy/ssh-action@master
         with:
           host: ${{ secrets.PROD_HOST }}
           username: ${{ secrets.PROD_USER }}
           key: ${{ secrets.PROD_SSH_KEY }}
           script: |
             cd /opt/mirror-realm
             git pull origin main
             docker-compose -f docker-compose.prod.yml up -d --build
   ```

#### 9.4.3 è—åº¦å‘å¸ƒç­–ç•¥

1. **è—ç¶ éƒ¨ç½²å¯¦ç¾**
   ```bash
   # blue-green-deploy.sh
   #!/bin/bash
   
   set -e
   
   # åƒæ•¸
   SERVICE_NAME=$1
   NEW_VERSION=$2
   TRAFFIC_PERCENTAGE=${3:-0}
   
   echo "Starting blue-green deployment for $SERVICE_NAME to version $NEW_VERSION"
   
   # 1. éƒ¨ç½²æ–°ç‰ˆæœ¬ï¼ˆç¶ è‰²ç¯å¢ƒï¼‰
   echo "Deploying new version to green environment"
   kubectl apply -f manifests/$SERVICE_NAME-green.yaml
   
   # 2. ç­‰å¾…æ–°ç‰ˆæœ¬å‡†å‚™å°±ç»ª
   echo "Waiting for green environment to be ready"
   kubectl rollout status deployment/$SERVICE_NAME-green
   
   # 3. é€æ­¥åˆ‡æ›æµé‡
   if [ "$TRAFFIC_PERCENTAGE" -gt 0 ]; then
     echo "Shifting $TRAFFIC_PERCENTAGE% of traffic to green environment"
     kubectl patch virtualservice/$SERVICE_NAME -n istio-system -p \
       '{"spec":{"http":[{"route":[{"destination":{"host":"'$SERVICE_NAME'-green"}, "weight":'$TRAFFIC_PERCENTAGE'}]}]}}'
   else
     echo "Switching all traffic to green environment"
     kubectl patch virtualservice/$SERVICE_NAME -n istio-system -p \
       '{"spec":{"http":[{"route":[{"destination":{"host":"'$SERVICE_NAME'-green"}, "weight":100}]}]}}'
   fi
   
   # 4. éªŒè¡Œæµ‹è¯•
   echo "Running smoke tests"
   ./smoke-tests.sh $SERVICE_NAME
   
   # 5. å®Œæˆåˆ‡æ›æˆ–å›æ»š
   if [ $? -eq 0 ]; then
     echo "Deployment successful, cleaning up old version"
     kubectl delete deployment/$SERVICE_NAME-blue
   else
     echo "Deployment failed, rolling back to blue environment"
     kubectl patch virtualservice/$SERVICE_NAME -n istio-system -p \
       '{"spec":{"http":[{"route":[{"destination":{"host":"'$SERVICE_NAME'-blue"}, "weight":100}]}]}}'
     exit 1
   fi
   ```

2. **é‡‘ä¸é›€å‘å¸ƒå¯¦ç¾**
   ```bash
   # canary-release.sh
   #!/bin/bash
   
   set -e
   
   # åƒæ•¸
   SERVICE_NAME=$1
   NEW_VERSION=$2
   CANARY_PERCENTAGE=${3:-5}
   INTERVAL=${4:-5}
   DURATION=${5:-30}
   
   echo "Starting canary release for $SERVICE_NAME to version $NEW_VERSION"
   
   # 1. éƒ¨ç½²é‡‘ä¸é›€ç‰ˆæœ¬
   echo "Deploying canary version"
   sed "s/{{VERSION}}/$NEW_VERSION/g" manifests/$SERVICE_NAME-canary.yaml | kubectl apply -f -
   
   # 2. ç­‰å¾…é‡‘ä¸é›€ç‰ˆæœ¬å‡†å‚™å°±ç»ª
   echo "Waiting for canary version to be ready"
   kubectl rollout status deployment/$SERVICE_NAME-canary
   
   # 3. é€æ­¥å¢åŠ é‡‘ä¸é›€æµé‡
   total_steps=$((DURATION / INTERVAL))
   for i in $(seq 1 $total_steps); do
     current_percentage=$((CANARY_PERCENTAGE * i / total_steps))
     
     echo "Shifting $current_percentage% of traffic to canary version"
     kubectl patch virtualservice/$SERVICE_NAME -n istio-system -p \
       "{\"spec\":{\"http\":[{\"route\":[{\"destination\":{\"host\":\"$SERVICE_NAME\"}, \"weight\":$((100 - current_percentage))},{\"destination\":{\"host\":\"$SERVICE_NAME-canary\"}, \"weight\":$current_percentage}]}]}}"
     
     # æª¢æŸ¥æŒ‡æ¨™
     ./check-metrics.sh $SERVICE_NAME $current_percentage
     
     # æª¢æŸ¥é”™è¯¯ç‡
     error_rate=$(./get-error-rate.sh $SERVICE_NAME-canary)
     if (( $(echo "$error_rate > 0.01" | bc -l) )); then
       echo "Error rate too high ($error_rate%), rolling back"
       kubectl patch virtualservice/$SERVICE_NAME -n istio-system -p \
         "{\"spec\":{\"http\":[{\"route\":[{\"destination\":{\"host\":\"$SERVICE_NAME\"}, \"weight\":100}]}]}}"
       exit 1
     fi
     
     sleep $INTERVAL
   done
   
   # 4. å®Œæˆé‡‘ä¸é›€å‘å¸ƒ
   echo "Canary release complete, promoting to full production"
   kubectl patch virtualservice/$SERVICE_NAME -n istio-system -p \
     "{\"spec\":{\"http\":[{\"route\":[{\"destination\":{\"host\":\"$SERVICE_NAME\"}, \"weight\":0},{\"destination\":{\"host\":\"$SERVICE_NAME-canary\"}, \"weight\":100}]}]}}"
   kubectl delete deployment/$SERVICE_NAME
   kubectl rollout status deployment/$SERVICE_NAME-canary
   kubectl patch deployment/$SERVICE_NAME-canary --type='json' -p='[{"op": "replace", "path": "/metadata/name", "value":"'$SERVICE_NAME'"}]'
   ```

---

## ğŸ“‘ ç›¸é—œç« ç¯€

| å‰åº | ç•¶å‰ | å¾ŒçºŒ |
|-----|------|------|
| [9.3 ç›£æ§èˆ‡å‘Šè­¦](ch9-3-ç›£æ§èˆ‡å‘Šè­¦.md) | **9.4 æŒçºŒæ•´åˆèˆ‡æŒçºŒéƒ¨ç½²** | [9.5 å®‰å…¨èˆ‡åˆè¦](ch9-5-å®‰å…¨èˆ‡åˆè¦.md) |

**å¿«é€Ÿéˆæ¥ï¼š**
- [9.3 ç›£æ§èˆ‡å‘Šè­¦](ch9-3-ç›£æ§èˆ‡å‘Šè­¦.md)
- [9.5 å®‰å…¨èˆ‡åˆè¦](ch9-5-å®‰å…¨èˆ‡åˆè¦.md)
- [â† è¿”å›ç¬¬9ç« é¦–é ](ch9-index.md)
