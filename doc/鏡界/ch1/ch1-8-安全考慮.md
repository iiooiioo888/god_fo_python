# 第1章：資料源註冊中心 (Data Source Registry)

## 1.8 安全考慮

**[← 返回第1章首頁](ch1-index.md)**

---

## 1.8.1 訪問控制

### 基於角色的訪問控制(RBAC)模型

```mermaid
flowchart TD
    A[Users] -->|member of| B[Projects]
    A -->|assigned to| C[Teams]
    B -->|contains| C
    C -->|has role| D[Roles]
    D -->|grants| E[Permissions]
    E -->|on| F[Resources]
```

*图1.10: RBAC模型關係图*

### 權限级别定義

| 權限级别 | 資料源操作 | 說明 |
|----------|------------|------|
| **查看者** | 读取 | 只能查看資料源詳情和使用資料源 |
| **编辑者** | 读取、更新 | 可以编辑資料源定義和配置 |
| **管理员** | 读取、更新、删除 | 完全控制資料源，包括删除和權限管理 |
| **所有者** | 读取、更新、删除、共享 | 创建者權限，可共享資料源 |

*表1.21: 權限级别定義*

### 用戶角色與權限體系

#### 用戶類型表

DSR 系統中支持以下主要用戶角色和類型：

| 角色類別 | 具體角色 | 主要職責 | 典型權限 | 使用場景 |
|---------|--------|--------|--------|--------|
| **管理員** | 平台管理員 | 系統配置、全局監控、審計管理 | 全部權限（CRUD）、系統配置、用戶管理 | 平台初始化、全局監控、合規審計 |
| | 租戶管理員 | 租戶級資源管理、成員角色分配 | 租戶內資源CRUD、成員管理、權限分配 | 多租戶環境下的資源隔離管理 |
| **資料所有者** | 資料源所有者 | 資料源元資訊維護、版本管理 | 自有資料源CRUD、版本回溯、權限授予 | 資料源上線、維護、變更管理 |
| | 數據管理員 | 全局資料品質監控、健康評估 | 健康評分修改、品質標籤編輯、監控策略配置 | 資料品質治理、SLA監控 |
| **使用者** | 資料分析師 | 查詢發現、分析資料源 | 查詢、下載、使用授權資料源 | 數據探索、臨時查詢 |
| | 開發工程師 | API集成、工作流配置 | 查詢、API調用、工作流參數配置 | ETL配置、自動化任務開發 |
| | 業務用戶 | 報表查看、資料訪問 | 查詢授權資料源、報表查看 | 業務決策、日常查詢 |
| **審計/合規** | 審計人員 | 操作日志審計、合規檢查 | 日志查詢、變更審計、合規報告 | 安全審計、合規驗證 |
| | 安全管理員 | 訪問控制、敏感資訊保護 | 權限策略配置、敏感標籤管理、加密策略 | 信息安全、數據保護 |

*表1.22: 用戶角色與職責定義*

#### 權限矩陣表

以下詳細列出各個角色對 DSR 系統中各項操作的權限：

| 操作 | 平台管理員 | 租戶管理員 | 資料所有者 | 數據管理員 | 分析師 | 開發工程師 | 審計人員 |
|------|----------|----------|----------|----------|------|----------|--------|
| **資料源管理** |
| 註冊新資料源 | ✓ | ✓ | ✓ | - | - | - | - |
| 編輯資料源信息 | ✓ | ✓ | ✓ | △ | - | - | - |
| 刪除資料源 | ✓ | ✓ | ✓ | - | - | - | - |
| 查詢資料源 | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| 批量導出資料源 | ✓ | △ | △ | △ | △ | △ | ✓ |
| **版本與變更** |
| 查看版本歷史 | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| 版本回溯 | ✓ | ✓ | ✓ | - | - | - | - |
| 版本對比 | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| 變更審批 | ✓ | △ | - | - | - | - | - |
| **權限與訪問** |
| 授予訪問權限 | ✓ | ✓ | ✓ | - | - | - | - |
| 撤銷訪問權限 | ✓ | ✓ | ✓ | - | - | - | - |
| 查看授權列表 | ✓ | ✓ | ✓ | △ | - | ✓ | ✓ |
| 管理角色模板 | ✓ | - | - | - | - | - | - |
| **監控與評估** |
| 查看健康狀態 | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| 修改品質評分 | ✓ | - | - | ✓ | - | - | - |
| 配置監控策略 | ✓ | - | - | ✓ | - | - | - |
| 生成健康報告 | ✓ | △ | △ | ✓ | - | - | ✓ |
| **審計與合規** |
| 查看審計日志 | ✓ | △ | △ | △ | - | - | ✓ |
| 導出合規報告 | ✓ | - | - | - | - | - | ✓ |
| 配置審計規則 | ✓ | - | - | - | - | - | - |
| 查看操作統計 | ✓ | △ | △ | △ | - | - | ✓ |
| **系統配置** |
| 系統參數設置 | ✓ | - | - | - | - | - | - |
| 集成配置 | ✓ | - | - | - | - | - | - |
| 用戶角色分配 | ✓ | ✓ | - | - | - | - | - |
| 權限策略配置 | ✓ | - | - | - | - | - | - |

*表1.23: 權限矩陣表*

**圖例說明：**
- ✓ = 完全權限
- △ = 部分/受限權限（僅限自己租戶/部門內資源）
- \- = 無權限

---

## 1.8.2 資料安全

### 資料安全控制矩阵

| 資料類型 | 加密方式 | 儲存方式 | 訪問控制 | 審計要求 |
|----------|----------|----------|----------|----------|
| **API密钥** | KMS加密 | 密文儲存 | 字段级控制 | 完整審計 |
| **用戶凭證** | KMS加密 | 密文儲存 | 严格控制 | 完整審計 |
| **業務資料** | 透明加密 | 密文儲存 | 專案级控制 | 操作審計 |
| **元資料** | 无 | 明文儲存 | 基於角色 | 關鍵操作審計 |
| **日志資料** | 部分加密 | 密文/明文 | 只读訪問 | 无 |

*表1.22: 資料安全控制矩阵*

### 加密效能指標

| 操作 | 資料大小 | 平均時間 | P99時間 | 說明 |
|------|----------|----------|---------|------|
| 加密 | 100字節 | 0.5ms | 1.2ms | API密钥加密 |
| 加密 | 1KB | 0.8ms | 1.5ms | 配置資料加密 |
| 加密 | 10KB | 2.3ms | 4.0ms | 大文档加密 |
| 解密 | 100字節 | 0.4ms | 1.0ms | API密钥解密 |
| 解密 | 1KB | 0.7ms | 1.3ms | 配置資料解密 |
| 解密 | 10KB | 2.0ms | 3.5ms | 大文档解密 |

*表1.23: 加密效能指標*

---

## 1.8.3 加密與密鑰管理

### 加密策略

#### 傳輸層安全 (TLS)

- **協議版本**：TLS 1.3（推薦）或 TLS 1.2
- **密码套件**：
  - 推薦：`TLS_AES_256_GCM_SHA384`、`TLS_CHACHA20_POLY1305_SHA256`
  - 接受：`TLS_AES_128_GCM_SHA256`
- **証書**：
  - 所有 HTTPS 連接使用有效的 SSL 証書
  - 證書由可信的 CA 簽發
  - 自動更新，不超過 90 天

#### 靜態數據加密 (At-Rest)

| 資料類型 | 加密算法 | 密鑰管理 | 說明 |
|---------|---------|---------|------|
| 敏感憑證 | AES-256-GCM | KMS | 使用 AWS KMS 或同等服務管理主密鑰 |
| 配置文件 | AES-256-GCM | KMS | 配置中的密碼、API 密鑰等 |
| 業務資料 | AES-128-GCM | 內部 | 支援透明加密，性能優先 |
| 日志數據 | AES-128-GCM | 內部 | 敏感日志加密，非敏感日志明文存儲 |

*表 1.24: 靜態數據加密策略*

### 密鑰管理策略

#### 密鑰生命週期

```
生成 → 分發 → 輪換 → 備份 → 銷毀

- 生成：使用密碼學安全的隨機數生成器
- 分發：通過安全的通道分發給授權的系統
- 輪換：主密鑰每年輪換一次，工作密鑰每 90 天輪換一次
- 備份：加密備份至地理位置分散的位置
- 銷毀：使用安全的密鑰銷毀協議（如 NIST SP 800-88）
```

#### 密鑰存儲

- **主密鑰**：
  - 存儲在專用硬件安全模塊 (HSM) 中
  - 永遠不允許導出到軟件存儲
  - 不可被任何應用程序直接訪問

- **工作密鑰**：
  - 由主密鑰加密後存儲
  - 運行時存儲在內存中
  - 支援多副本備份（加密狀態）

---

## 1.8.4 審計與日志

### 審計日志格式

```json
{
  "auditLogId": "audit_2024103110300001",
  "timestamp": "2024-10-31T10:30:00.123Z",
  "operator": {
    "userId": "user_123",
    "username": "alice@example.com",
    "ipAddress": "192.168.1.100",
    "userAgent": "Mozilla/5.0..."
  },
  "operation": {
    "action": "UPDATE_DATASOURCE",
    "resourceType": "DataSource",
    "resourceId": "ds_001",
    "resourceName": "用戶行為數據源",
    "status": "SUCCESS",
    "errorCode": null,
    "errorMessage": null
  },
  "changes": {
    "before": {
      "name": "用戶行為分析",
      "status": "active"
    },
    "after": {
      "name": "用戶行為分析_v2",
      "status": "active"
    }
  },
  "context": {
    "tenantId": "tenant_001",
    "sourceSystem": "web_portal",
    "requestId": "req_abc123def456",
    "sessionId": "sess_xyz789"
  },
  "security": {
    "dataClassification": "confidential",
    "impactLevel": "high",
    "riskScore": 5
  }
}
```

*示例 1.2: 審計日志完整格式*

### 審計事件類型

#### 資料源操作審計

| 事件類型 | 審計項 | 記錄要求 | 保留期 |
|---------|--------|--------|--------|
| 註冊資料源 | 資料源類型、連接信息摘要、所有者 | 必須 | 2 年 |
| 更新資料源 | 所有變更字段的前後值 | 必須 | 2 年 |
| 刪除資料源 | 完整的資料源配置備份 | 必須 | 5 年 |
| 查詢資料源 | 查詢條件、返回結果數量 | 條件性 | 30 天 |
| 導出資料 | 導出的資料源清單、大小 | 必須 | 1 年 |

#### 訪問控制審計

| 事件類型 | 審計項 | 記錄要求 | 保留期 |
|---------|--------|--------|--------|
| 授予權限 | 被授予者、權限級別、資源、有效期 | 必須 | 2 年 |
| 撤銷權限 | 被撤銷者、原權限級別、撤銷原因 | 必須 | 2 年 |
| 權限檢查失敗 | 嘗試用戶、拒絕理由 | 必須 | 90 天 |
| 角色變更 | 涉及用戶、舊角色、新角色 | 必須 | 1 年 |

#### 系統管理審計

| 事件類型 | 審計項 | 記錄要求 | 保留期 |
|---------|--------|--------|--------|
| 系統配置變更 | 配置項、舊值、新值 | 必須 | 2 年 |
| 密鑰輪換 | 密鑰版本、輪換理由 | 必須 | 5 年 |
| 安全政策更新 | 政策版本、變更內容 | 必須 | 3 年 |
| 合規檢查 | 檢查時間、結果、不符項 | 必須 | 1 年 |

*表 1.25: 審計事件分類與要求*

### 審計日志訪問控制

- **查看權限**：
  - 審計人員：可查看所有審計日志
  - 租戶管理員：只能查看自己租戶的審計日志
  - 一般用戶：只能查看與自己相關的審計日志

- **導出限制**：
  - 每次最多導出 100 萬條日志
  - 導出操作本身被記錄
  - 導出內容加密存儲

- **日志完整性**：
  - 使用區塊鏈（可選）確保日志不可篡改
  - 定期生成日志摘要 (Merkle tree)
  - 跨系統備份

---

## 1.8.5 安全最佳實踐

### 開發人員指南

#### 1. 密碼安全存儲

❌ **不要做**
```python
# 直接存儲密碼在代碼中
DB_PASSWORD = "mySecurePassword123"

# 通過 URL 參數傳遞密碼
connection_string = "postgresql://user:password@host:5432/db"
```

✅ **應該做**
```python
from aws_secretsmanager import get_secret

# 從密鑰管理服務獲取
DB_PASSWORD = get_secret('prod/database/password')

# 使用環境變量
import os
DB_PASSWORD = os.environ.get('DB_PASSWORD')
```

#### 2. SQL 注入防護

❌ **不要做**
```python
query = f"SELECT * FROM datasources WHERE id = {user_input}"
result = db.execute(query)
```

✅ **應該做**
```python
query = "SELECT * FROM datasources WHERE id = %s"
result = db.execute(query, (user_input,))
```

#### 3. 日志敏感信息處理

❌ **不要做**
```python
logger.info(f"User {username} connected with password {password}")
```

✅ **應該做**
```python
logger.info(f"User {username} connected successfully")
# 敏感信息單獨記錄到安全日志系統
secure_logger.log_sensitive_event('password_used', user_id=user_id)
```

### 運維人員指南

#### 日常安全檢查清單

- [ ] 檢查審計日志，查找異常訪問
- [ ] 驗證所有密鑰仍在 HSM 中（週一）
- [ ] 檢查是否有過期的訪問令牌或會話
- [ ] 確認備份加密完整（每日）
- [ ] 驗證 TLS 証書有效期（每月）
- [ ] 運行安全掃描（每週）
- [ ] 生成合規報告（每月）

#### 事件響應流程

```
檢測到異常
    ↓
1. 隔離受影響系統
    ↓
2. 收集詳細的審計日志
    ↓
3. 分析根本原因
    ↓
4. 執行補救措施
    ↓
5. 通知相關方
    ↓
6. 記錄事件報告
    ↓
7. 實施預防措施
```

---

## 1.8.6 安全政策與合規

### 密碼政策

| 項目 | 要求 | 說明 |
|------|------|------|
| 最小長度 | 12 字符 | 支援 Unicode 字符 |
| 複雜度 | 至少 3 種類型 | 大寫、小寫、數字、特殊字符 |
| 有效期 | 90 天 | 過期後強制修改 |
| 歷史記錄 | 最後 5 個 | 不允許重用最近的密碼 |
| 鎖定政策 | 5 次失敗後鎖定 1 小時 | 管理員可手動解鎖 |

*表 1.26: 密碼政策*

### 會話管理

| 項目 | 要求 | 說明 |
|------|------|------|
| 會話超時 | 30 分鐘無操作自動登出 | 可配置 |
| 並發會話限制 | 每個用戶最多 3 個會話 | 超過限制時提示 |
| 會話令牌 | JWT + HttpOnly Cookie | 防止 XSS 攻擊 |
| CSRF 防護 | 使用 SameSite Cookie | Strict 模式 |

*表 1.27: 會話管理政策*

---

## 📑 相關章節

| 前序 | 當前 | 後續 |
|-----|------|------|
| [1.7 效能優化策略](ch1-7-效能優化策略.md) | **1.8 安全考慮** | [1.9 與其他模組的交互](ch1-9-與其他模組的交互.md) |

**快速鏈接：**
- [1.7 效能優化策略](ch1-7-效能優化策略.md)
- [1.9 與其他模組的交互](ch1-9-與其他模組的交互.md)
- [← 返回第1章首頁](ch1-index.md)
