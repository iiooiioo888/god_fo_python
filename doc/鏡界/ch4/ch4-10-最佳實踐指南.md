**[← 返回第4章首頁](ch4-index.md)**

---

# 第4章：資料處理工作流引擎 - 最佳實踐指南

## 工作流設計最佳實踐

### 1. 工作流定義規範

**任務粒度設計**
- ✅ **適度粒度**: 每個任務代表一個獨立的業務操作
- ✅ **單一職責**: 任務只做一件事
- ✅ **可重用性**: 設計通用的任務處理器

**依賴關係管理**
```yaml
# 推薦做法
tasks:
  - id: extract
    dependencies: []
  - id: validate
    dependencies: [extract]
  - id: transform
    dependencies: [validate]
  - id: store
    dependencies: [transform]
```

### 2. 並行執行策略

**識別並行機會**
```python
# 可並行執行的任務
tasks:
  - id: load_from_source_a
    dependencies: []
  - id: load_from_source_b
    dependencies: []
  - id: load_from_source_c
    dependencies: []
  - id: merge
    dependencies: [load_from_source_a, load_from_source_b, load_from_source_c]
```

## 錯誤處理最佳實踐

### 3. 重試策略

**指數退避配置**
```python
retry_policy = {
    "max_retries": 3,
    "backoff": "exponential",
    "initial_delay": 1,
    "max_delay": 60
}
```

### 4. 補償機制

**設計可撤銷的任務**
```python
task = {
    "id": "store_data",
    "handler": "data_store",
    "compensation": {
        "handler": "data_delete",
        "params": {"table": "staging"}
    }
}
```

## 性能優化

### 5. 大規模數據處理

- **分片處理**: 將大任務分解為多個小任務
- **批量操作**: 減少數據庫往返次數
- **緩存中間結果**: 避免重複計算

### 6. 監控與告警

**關鍵指標**
| 指標 | 目標 | 告警閾值 |
|------|------|---------|
| 平均執行時間 | < 5分鐘 | > 10分鐘 |
| 失敗率 | < 1% | > 5% |
| 任務超時 | 0 | > 0 |

## 常見問題與解決

### 問題 1: 工作流執行緩慢

**診斷步驟**
1. 檢查每個任務的執行時間
2. 識別關鍵路徑
3. 尋找可並行化的任務

**解決方案**
- 優化慢任務的算法
- 增加並行任務數
- 使用緩存加速

### 問題 2: 循環依賴

**檢測與修復**
```python
def detect_circular_dependency(tasks):
    """檢測循環依賴"""
    graph = {t['id']: t.get('dependencies', []) for t in tasks}
    visited = set()
    rec_stack = set()
    
    def has_cycle(node):
        visited.add(node)
        rec_stack.add(node)
        
        for neighbor in graph.get(node, []):
            if neighbor not in visited:
                if has_cycle(neighbor):
                    return True
            elif neighbor in rec_stack:
                return True
        
        rec_stack.remove(node)
        return False
    
    return any(has_cycle(node) for node in graph if node not in visited)
```

---

## 相關文件引用

- **核心實現**: [代碼示例 - 工作流引擎](../ch4-code-examples/ch4-code-01-workflow-engine.md)
- **服務集成**: [代碼示例 - 服務集成](../ch4-code-examples/ch4-code-02-service-integration.md)
- **數據庫**: [代碼示例 - 數據庫定義](../ch4-code-examples/ch4-code-03-database-schema.md)
- **API**: [代碼示例 - API 端點](../ch4-code-examples/ch4-code-04-api-examples.md)
