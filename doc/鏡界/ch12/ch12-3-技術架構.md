# 第12章：數據質量管理中心

## 12.3 技術架構

**[← 返回第12章首頁](ch12-index.md)**

---

## 🏗️ 整體技術架構

### 分層架構設計

```
┌───────────────────────────────────────────────────────────────────┐
│                       應用層（Application Layer）                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  Quality Dashboard │ Report Generator │ Alert Manager       │ │
│  │  質量看板         │ 報告生成器       │ 告警管理            │ │
│  └─────────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────────┘
                                ↓
┌───────────────────────────────────────────────────────────────────┐
│                       API 層（API Layer）                          │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  REST API      │  Streaming API     │  Batch API            │ │
│  │  (單條檢查)    │  (流式處理)        │  (批量處理)           │ │
│  └─────────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────────┘
                                ↓
┌───────────────────────────────────────────────────────────────────┐
│                       服務層（Service Layer）                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  Quality     │  │  Cleaning    │  │  Validation  │          │
│  │  Monitor     │  │  Service     │  │  Service     │          │
│  │  質量監控    │  │  清洗服務    │  │  校驗服務    │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  Anomaly     │  │  Lineage     │  │  Scoring     │          │
│  │  Detection   │  │  Tracker     │  │  Service     │          │
│  │  異常檢測    │  │  血緣追蹤    │  │  評分服務    │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└───────────────────────────────────────────────────────────────────┘
                                ↓
┌───────────────────────────────────────────────────────────────────┐
│                       引擎層（Engine Layer）                       │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  Rule Engine        │  ML Engine        │  ETL Engine       │ │
│  │  規則引擎          │  機器學習引擎     │  數據處理引擎     │ │
│  │  • Drools          │  • Scikit-learn   │  • PySpark        │ │
│  │  • Easy Rules      │  • PyOD           │  • Pandas         │ │
│  └─────────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────────┘
                                ↓
┌───────────────────────────────────────────────────────────────────┐
│                       數據層（Data Layer）                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ PostgreSQL   │  │ MongoDB      │  │ InfluxDB     │          │
│  │ 質量元數據   │  │ 清洗規則     │  │ 質量歷史     │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ Redis        │  │ Kafka        │  │ MinIO        │          │
│  │ 快取/鎖      │  │ 事件流       │  │ 對象存儲     │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└───────────────────────────────────────────────────────────────────┘
```

---

## 🎯 核心組件架構

### 1. 質量監控架構

```
┌────────────────────────────────────────────────────────────┐
│                   Quality Monitor                           │
│  ┌────────────────────────────────────────────────────┐   │
│  │  Data Source Connector                              │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐     │   │
│  │  │ Ch8 爬蟲  │  │ Ch1 數據源│  │ 外部API   │     │   │
│  │  │   接入    │  │   接入    │  │   接入    │     │   │
│  │  └───────────┘  └───────────┘  └───────────┘     │   │
│  └────────────────────────────────────────────────────┘   │
│                        ↓                                    │
│  ┌────────────────────────────────────────────────────┐   │
│  │  Real-time Quality Check                            │   │
│  │  • 完整性檢查（Null, Missing）                      │   │
│  │  • 準確性檢查（Format, Range）                      │   │
│  │  • 一致性檢查（Cross-table）                        │   │
│  │  • 時效性檢查（Timestamp）                          │   │
│  │  • 唯一性檢查（Duplicate）                          │   │
│  └────────────────────────────────────────────────────┘   │
│                        ↓                                    │
│  ┌────────────────────────────────────────────────────┐   │
│  │  Quality Metrics Aggregation                        │   │
│  │  • 按時間聚合（分鐘/小時/天）                       │   │
│  │  • 按來源聚合（Ch8/Ch1/External）                   │   │
│  │  • 按質量維度聚合（5維）                            │   │
│  └────────────────────────────────────────────────────┘   │
│                        ↓                                    │
│  ┌────────────────────────────────────────────────────┐   │
│  │  Alert & Notification                               │   │
│  │  • 質量閾值告警                                     │   │
│  │  • 異常趨勢告警                                     │   │
│  │  • 多渠道通知（Email/Slack/DingTalk）              │   │
│  └────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────┘
```

#### 監控指標體系

```
質量指標樹
├── 完整性指標
│   ├── 空值率（Null Rate）
│   ├── 缺失率（Missing Rate）
│   └── 必填字段完整率
├── 準確性指標
│   ├── 格式正確率
│   ├── 範圍有效率
│   └── 類型匹配率
├── 一致性指標
│   ├── 跨表一致率
│   ├── 邏輯一致率
│   └── 參照完整性
├── 時效性指標
│   ├── 數據新鮮度
│   ├── 更新延遲
│   └── 過期數據率
└── 唯一性指標
    ├── 重複率
    ├── 主鍵唯一率
    └── 業務唯一鍵率
```

### 2. 數據清洗引擎架構

```
┌────────────────────────────────────────────────────────────┐
│                   Cleaning Engine                           │
│  ┌────────────────────────────────────────────────────┐   │
│  │  Data Profiling                                     │   │
│  │  • 數據類型檢測                                     │   │
│  │  • 分佈特徵分析                                     │   │
│  │  • 異常值識別                                       │   │
│  └────────────────────────────────────────────────────┘   │
│                        ↓                                    │
│  ┌────────────────────────────────────────────────────┐   │
│  │  Cleaning Strategy Selection                        │   │
│  │  ┌──────────────┐  ┌──────────────┐               │   │
│  │  │  Rule-Based  │  │  ML-Based    │               │   │
│  │  │  規則清洗    │  │  智能清洗    │               │   │
│  │  └──────────────┘  └──────────────┘               │   │
│  └────────────────────────────────────────────────────┘   │
│                        ↓                                    │
│  ┌────────────────────────────────────────────────────┐   │
│  │  Cleaning Operations (Pipeline)                     │   │
│  │  ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐    │   │
│  │  │去重 │→│格式化│→│標準化│→│補缺值│→│驗證 │    │   │
│  │  └─────┘  └─────┘  └─────┘  └─────┘  └─────┘    │   │
│  └────────────────────────────────────────────────────┘   │
│                        ↓                                    │
│  ┌────────────────────────────────────────────────────┐   │
│  │  Quality Verification                               │   │
│  │  • 清洗前後對比                                     │   │
│  │  • 質量分數計算                                     │   │
│  │  • 清洗報告生成                                     │   │
│  └────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────┘
```

#### 清洗管道配置

```python
# 清洗管道配置示例
cleaning_pipeline = {
    "stages": [
        {
            "name": "deduplication",
            "type": "remove_duplicates",
            "config": {
                "key_columns": ["url", "title"],
                "keep": "first"
            }
        },
        {
            "name": "format_normalization",
            "type": "normalize_format",
            "config": {
                "columns": {
                    "email": "lowercase|trim",
                    "phone": "format:+86-XXX-XXXX-XXXX",
                    "date": "format:YYYY-MM-DD"
                }
            }
        },
        {
            "name": "missing_value_handling",
            "type": "fill_missing",
            "config": {
                "strategies": {
                    "numerical": "median",
                    "categorical": "mode",
                    "datetime": "forward_fill"
                }
            }
        },
        {
            "name": "outlier_removal",
            "type": "remove_outliers",
            "config": {
                "method": "iqr",
                "threshold": 3.0
            }
        },
        {
            "name": "validation",
            "type": "validate_rules",
            "config": {
                "rules": [
                    "age >= 0 AND age <= 150",
                    "email MATCHES '^[\\w\\.-]+@[\\w\\.-]+\\.\\w+$'",
                    "price > 0"
                ]
            }
        }
    ]
}
```

### 3. 異常檢測架構

```
┌────────────────────────────────────────────────────────────┐
│                 Anomaly Detection System                    │
│  ┌────────────────────────────────────────────────────┐   │
│  │  Feature Engineering                                │   │
│  │  • 統計特徵（均值、方差、分位數）                   │   │
│  │  • 時序特徵（趨勢、季節性）                         │   │
│  │  • 關聯特徵（跨字段關聯）                           │   │
│  └────────────────────────────────────────────────────┘   │
│                        ↓                                    │
│  ┌────────────────────────────────────────────────────┐   │
│  │  Detection Methods (Ensemble)                       │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌───────────┐ │   │
│  │  │ Statistical │  │  ML-Based   │  │ Rule-Based│ │   │
│  │  │   方法      │  │   方法      │  │   方法    │ │   │
│  │  │             │  │             │  │           │ │   │
│  │  │ • Z-Score   │  │ • Isolation │  │ • Thresh  │ │   │
│  │  │ • IQR       │  │   Forest    │  │ • Range   │ │   │
│  │  │ • MAD       │  │ • LOF       │  │ • Pattern │ │   │
│  │  │ • Grubbs    │  │ • DBSCAN    │  │           │ │   │
│  │  └─────────────┘  └─────────────┘  └───────────┘ │   │
│  └────────────────────────────────────────────────────┘   │
│                        ↓                                    │
│  ┌────────────────────────────────────────────────────┐   │
│  │  Anomaly Scoring & Ranking                          │   │
│  │  • 異常分數計算（0-100）                            │   │
│  │  • 置信度評估                                       │   │
│  │  • 優先級排序                                       │   │
│  └────────────────────────────────────────────────────┘   │
│                        ↓                                    │
│  ┌────────────────────────────────────────────────────┐   │
│  │  Alert & Action                                     │   │
│  │  • 實時告警（高優先級）                             │   │
│  │  • 批量分析（低優先級）                             │   │
│  │  • 自動修復建議                                     │   │
│  └────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────┘
```

#### 多模型融合

```
異常檢測模型融合
┌──────────────────────────────────────┐
│  輸入數據                             │
└──────────────────────────────────────┘
        ↓        ↓        ↓
┌──────────┐┌──────────┐┌──────────┐
│統計模型  ││機器學習  ││規則引擎  │
│Z-Score   ││Isolation ││Threshold │
│得分: 0.8 ││得分: 0.7 ││得分: 0.9 │
└──────────┘└──────────┘└──────────┘
        ↓        ↓        ↓
┌──────────────────────────────────────┐
│  加權融合                             │
│  最終得分 = 0.3×0.8 + 0.5×0.7        │
│            + 0.2×0.9 = 0.77          │
└──────────────────────────────────────┘
        ↓
┌──────────────────────────────────────┐
│  異常判定                             │
│  > 0.7: 高度異常 → 立即告警          │
│  0.5-0.7: 可疑 → 記錄待審核          │
│  < 0.5: 正常                         │
└──────────────────────────────────────┘
```

### 4. 數據血緣架構

```
┌────────────────────────────────────────────────────────────┐
│                   Data Lineage Tracker                      │
│  ┌────────────────────────────────────────────────────┐   │
│  │  Metadata Collector                                 │   │
│  │  • 數據源元數據                                     │   │
│  │  • 轉換邏輯元數據                                   │   │
│  │  • 執行記錄元數據                                   │   │
│  └────────────────────────────────────────────────────┘   │
│                        ↓                                    │
│  ┌────────────────────────────────────────────────────┐   │
│  │  Lineage Graph Builder                              │   │
│  │  ┌────────────────────────────────────────────┐   │   │
│  │  │  數據血緣圖（DAG）                         │   │   │
│  │  │                                             │   │   │
│  │  │  Source A ──┐                              │   │   │
│  │  │             ├──→ Transform ──→ Target A   │   │   │
│  │  │  Source B ──┘         ↓                    │   │   │
│  │  │                       └──→ Target B        │   │   │
│  │  └────────────────────────────────────────────┘   │   │
│  └────────────────────────────────────────────────────┘   │
│                        ↓                                    │
│  ┌────────────────────────────────────────────────────┐   │
│  │  Impact Analysis                                    │   │
│  │  • 上游影響分析（哪些源影響此表）                   │   │
│  │  • 下游影響分析（此表影響哪些目標）                 │   │
│  │  • 變更影響評估                                     │   │
│  └────────────────────────────────────────────────────┘   │
│                        ↓                                    │
│  ┌────────────────────────────────────────────────────┐   │
│  │  Lineage Query API                                  │   │
│  │  • 追溯查詢（往上追溯）                             │   │
│  │  • 影響查詢（往下追蹤）                             │   │
│  │  • 路徑查詢（端到端）                               │   │
│  └────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────┘
```

---

## 🔌 關鍵集成點

### 與 Great Expectations 集成

```
┌────────────────────────────────────────┐
│  Ch12 Quality Manager                   │
│  ┌──────────────────────────────────┐ │
│  │  Expectation Suite Manager        │ │
│  │  • 定義質量規則（Expectations）   │ │
│  │  • 管理規則集（Suite）           │ │
│  └──────────────────────────────────┘ │
└────────────────────────────────────────┘
                ↓
┌────────────────────────────────────────┐
│  Great Expectations                    │
│  • Validator（執行驗證）               │
│  • Data Context（配置管理）            │
│  • Checkpoint（檢查點）                │
└────────────────────────────────────────┘
                ↓
┌────────────────────────────────────────┐
│  Data Source                           │
│  • Pandas DataFrame                    │
│  • Spark DataFrame                     │
│  • SQL Database                        │
└────────────────────────────────────────┘
```

### 與 Apache Atlas 集成

```
┌────────────────────────────────────────┐
│  Ch12 Lineage Service                  │
│  • 採集血緣元數據                       │
│  • 構建血緣關係                         │
└────────────────────────────────────────┘
                ↓
┌────────────────────────────────────────┐
│  Apache Atlas                          │
│  • 元數據存儲                           │
│  • 血緣圖構建                           │
│  • 搜索與查詢 API                       │
└────────────────────────────────────────┘
                ↓
┌────────────────────────────────────────┐
│  Visualization                         │
│  • 血緣圖可視化                         │
│  • 影響分析報告                         │
└────────────────────────────────────────┘
```

---

## 📊 數據流架構

### 實時質量檢查流

```
┌──────────┐
│ Ch8 爬蟲 │ ──→ Kafka Topic: raw_data
└──────────┘
                ↓
┌───────────────────────────────────────┐
│  Ch10 Real-time Processing (Flink)    │
│  • 實時質量檢查                        │
│  • 數據清洗                            │
│  • 異常檢測                            │
└───────────────────────────────────────┘
        ↓                    ↓
Kafka: quality_issues   Kafka: cleaned_data
        ↓                    ↓
┌──────────────┐      ┌──────────────┐
│ Ch12 Alert   │      │ Ch1 數據源   │
│   Service    │      │   註冊       │
└──────────────┘      └──────────────┘
```

### 批量質量分析流

```
定時觸發 (Ch11 Scheduler)
        ↓
┌───────────────────────────────────────┐
│  Ch12 Batch Quality Analysis          │
│  • 加載數據                            │
│  │  ┌─────────────────────────────┐  │
│  │  │ Spark / Dask 分布式處理     │  │
│  │  └─────────────────────────────┘  │
│  • 執行質量檢查                        │
│  • 生成質量報告                        │
└───────────────────────────────────────┘
        ↓
┌───────────────────────────────────────┐
│  存儲質量結果                          │
│  • PostgreSQL (元數據)                │
│  • InfluxDB (時序指標)                │
│  • MinIO (報告文件)                   │
└───────────────────────────────────────┘
        ↓
┌───────────────────────────────────────┐
│  通知與展示                            │
│  • Email 報告                          │
│  • Grafana 看板                        │
│  • API 查詢                            │
└───────────────────────────────────────┘
```

---

## 🔒 安全與合規架構

### 數據安全

```
┌──────────────────────────────────────────┐
│  敏感數據處理                             │
│  ┌────────────────────────────────────┐ │
│  │  1. 數據脫敏                        │ │
│  │     • PII 識別（姓名、電話、身份證）│ │
│  │     • 自動脫敏（哈希/遮罩/替換）    │ │
│  └────────────────────────────────────┘ │
│  ┌────────────────────────────────────┐ │
│  │  2. 訪問控制                        │ │
│  │     • RBAC 權限控制                 │ │
│  │     • 字段級別權限                  │ │
│  │     • 審計日誌                      │ │
│  └────────────────────────────────────┘ │
│  ┌────────────────────────────────────┐ │
│  │  3. 加密存儲                        │ │
│  │     • 傳輸加密（TLS）               │ │
│  │     • 存儲加密（AES-256）           │ │
│  └────────────────────────────────────┘ │
└──────────────────────────────────────────┘
```

---

## 📑 相關章節

| 前序 | 當前 | 後續 |
|-----|------|------|
| [12.2 詳細功能清單](ch12-2-詳細功能清單.md) | **12.3 技術架構** | [12.4 核心組件](ch12-4-核心組件詳細實現.md) |

**快速鏈接：**
- [12.1 模組概述](ch12-1-模組概述.md)
- [12.4 核心組件詳細實現](ch12-4-核心組件詳細實現.md)
- [← 返回第12章首頁](ch12-index.md)

---

**最後更新**: 2025-10-31  
**版本**: 1.0

