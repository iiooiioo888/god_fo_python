<!-- LEGACY FILE NOTICE -->
> âš ï¸ æ­¤æª”æ¡ˆç‚ºèˆŠç‰ˆå‚™ä»½ï¼Œå·²è¢«æ–°æª”å–ä»£ï¼š [ch9-5-å®‰å…¨ä¸åˆè§„.md](ch9-5-å®‰å…¨ä¸åˆè§„.md)\n> å‚™ä»½æ™‚é–“ï¼š2025-10-31 12:28:27\n
---

**[â† è¿”å›ç¬¬9ç« é¦–é ](ch9-index.md)**

---

### 9.5 å®‰å…¨ä¸åˆè§„

#### 9.5.1 å®‰å…¨ç­–ç•¥

1. **ç½‘ç»œéš”ç¦»ç­–ç•¥**
   ```yaml
   # network-policy.yaml
   apiVersion: networking.k8s.io/v1
   kind: NetworkPolicy
   metadata:
     name: mirror-realm-network-policy
   spec:
     podSelector: {}
     policyTypes:
     - Ingress
     - Egress
     ingress:
     - from:
       - namespaceSelector:
           matchLabels:
             project: mirror-realm
         podSelector:
           matchLabels:
             app: api-gateway
       ports:
       - protocol: TCP
         port: 8000
     egress:
     - to:
       - namespaceSelector:
           matchLabels:
             project: mirror-realm
         podSelector:
           matchLabels:
             app: postgres
       ports:
       - protocol: TCP
         port: 5432
     - to:
       - namespaceSelector:
           matchLabels:
             project: mirror-realm
         podSelector:
           matchLabels:
             app: redis
       ports:
       - protocol: TCP
         port: 6379
   ```

2. **å®‰å…¨æ‰«æç­–ç•¥**
   ```yaml
   # security-scan.yaml
   apiVersion: batch/v1
   kind: CronJob
   metadata:
     name: security-scan
   spec:
     schedule: "0 2 * * *"
     jobTemplate:
       spec:
         template:
           spec:
             containers:
             - name: trivy
               image: aquasec/trivy:0.16.0
               command: ["trivy"]
               args: 
                 - "--severity", "CRITICAL,HIGH"
                 - "kubernetes"
                 - "--format", "table"
                 - "--exit-code", "1"
               volumeMounts:
               - name: kubeconfig
                 mountPath: /root/.kube
             volumes:
             - name: kubeconfig
               secret:
                 secretName: kubeconfig
             restartPolicy: OnFailure
   ```

#### 9.5.2 åˆè§„æ€§æ£€æŸ¥

1. **è‡ªåŠ¨åŒ–åˆè§„å·¥ä½œæµ**
   ```python
   class ComplianceWorkflow:
       """è‡ªåŠ¨åŒ–åˆè§„å·¥ä½œæµ"""
       
       def __init__(
           self,
           compliance_service: ComplianceService,
           notification_service: NotificationService,
           config: Config
       ):
           self.compliance_service = compliance_service
           self.notification_service = notification_service
           self.config = config
           self.logger = logging.getLogger(__name__)
       
       def run_daily_check(self):
           """æ‰§è¡Œæ¯æ—¥åˆè§„æ€§æ£€æŸ¥"""
           # 1. è·å–æ‰€æœ‰æ´»è·ƒæ•°æ®æº
           data_sources = self.compliance_service.get_active_data_sources()
           
           # 2. æ£€æŸ¥æ¯ä¸ªæ•°æ®æº
           non_compliant_sources = []
           for ds in data_sources:
               result = self.compliance_service.check_compliance(ds)
               if result.status != "compliant":
                   non_compliant_sources.append((ds, result))
           
           # 3. ç”ŸæˆæŠ¥å‘Š
           report = self._generate_report(non_compliant_sources)
           
           # 4. å‘é€é€šçŸ¥
           self._send_notifications(report)
           
           # 5. è·Ÿè¸ªé—®é¢˜
           self._track_issues(non_compliant_sources)
       
       def _generate_report(self, non_compliant_sources: List) -> ComplianceReport:
           """ç”Ÿæˆåˆè§„æ€§æŠ¥å‘Š"""
           return ComplianceReport(
               date=datetime.utcnow(),
               total_sources=len(data_sources),
               compliant_count=len(data_sources) - len(non_compliant_sources),
               non_compliant_count=len(non_compliant_sources),
               critical_issues=sum(1 for _, r in non_compliant_sources if r.critical_issues > 0),
               details=non_compliant_sources
           )
       
       def _send_notifications(self, report: ComplianceReport):
           """å‘é€é€šçŸ¥"""
           # å‘é€ç»™åˆè§„å›¢é˜Ÿ
           self.notification_service.send_email(
               to=self.config.compliance_team_email,
               subject=f"Daily Compliance Report - {report.date.strftime('%Y-%m-%d')}",
               body=self._format_report_email(report)
           )
           
           # å¦‚æœæœ‰å…³é”®é—®é¢˜ï¼Œå‘é€è­¦æŠ¥
           if report.critical_issues > 0:
               self.notification_service.send_slack_alert(
                   channel=self.config.alert_channel,
                   message=f"Critical compliance issues detected! {report.critical_issues} sources affected."
               )
       
       def _track_issues(self, non_compliant_sources: List):
           """è·Ÿè¸ªåˆè§„æ€§é—®é¢˜"""
           for ds, result in non_compliant_sources:
               # åˆ›å»ºæˆ–æ›´æ–°é—®é¢˜
               issue = self.compliance_service.get_issue(ds.id)
               if not issue:
                   self.compliance_service.create_issue(
                       data_source_id=ds.id,
                       description=result.suggestions[0] if result.suggestions else "Non-compliant data source",
                       severity="critical" if result.critical_issues > 0 else "high",
                       due_date=datetime.utcnow() + timedelta(days=7)
                   )
               else:
                   # æ›´æ–°ç°æœ‰é—®é¢˜
                   self.compliance_service.update_issue(
                       issue.id,
                       status="open",
                       last_checked=datetime.utcnow()
                   )
   ```

---

## ğŸ“‘ ç›¸å…³ç« èŠ‚

| å‰åº | å½“å‰ | åç»­ |
|-----|------|------|
| [9.4](ch9-4.md) | **9.5** | [9.6](ch9-6.md) |

**å¿«é€Ÿé“¾æ¥ï¼š**
- [â† è¿”å›ç¬¬9ç« é¦–é ](ch9-index.md)
