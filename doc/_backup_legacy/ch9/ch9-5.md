<!-- LEGACY FILE NOTICE -->
> ⚠️ 此檔案為舊版備份，已被新檔取代： [ch9-5-安全与合规.md](ch9-5-安全与合规.md)\n> 備份時間：2025-10-31 12:28:27\n
---

**[← 返回第9章首頁](ch9-index.md)**

---

### 9.5 安全与合规

#### 9.5.1 安全策略

1. **网络隔离策略**
   ```yaml
   # network-policy.yaml
   apiVersion: networking.k8s.io/v1
   kind: NetworkPolicy
   metadata:
     name: mirror-realm-network-policy
   spec:
     podSelector: {}
     policyTypes:
     - Ingress
     - Egress
     ingress:
     - from:
       - namespaceSelector:
           matchLabels:
             project: mirror-realm
         podSelector:
           matchLabels:
             app: api-gateway
       ports:
       - protocol: TCP
         port: 8000
     egress:
     - to:
       - namespaceSelector:
           matchLabels:
             project: mirror-realm
         podSelector:
           matchLabels:
             app: postgres
       ports:
       - protocol: TCP
         port: 5432
     - to:
       - namespaceSelector:
           matchLabels:
             project: mirror-realm
         podSelector:
           matchLabels:
             app: redis
       ports:
       - protocol: TCP
         port: 6379
   ```

2. **安全扫描策略**
   ```yaml
   # security-scan.yaml
   apiVersion: batch/v1
   kind: CronJob
   metadata:
     name: security-scan
   spec:
     schedule: "0 2 * * *"
     jobTemplate:
       spec:
         template:
           spec:
             containers:
             - name: trivy
               image: aquasec/trivy:0.16.0
               command: ["trivy"]
               args: 
                 - "--severity", "CRITICAL,HIGH"
                 - "kubernetes"
                 - "--format", "table"
                 - "--exit-code", "1"
               volumeMounts:
               - name: kubeconfig
                 mountPath: /root/.kube
             volumes:
             - name: kubeconfig
               secret:
                 secretName: kubeconfig
             restartPolicy: OnFailure
   ```

#### 9.5.2 合规性检查

1. **自动化合规工作流**
   ```python
   class ComplianceWorkflow:
       """自动化合规工作流"""
       
       def __init__(
           self,
           compliance_service: ComplianceService,
           notification_service: NotificationService,
           config: Config
       ):
           self.compliance_service = compliance_service
           self.notification_service = notification_service
           self.config = config
           self.logger = logging.getLogger(__name__)
       
       def run_daily_check(self):
           """执行每日合规性检查"""
           # 1. 获取所有活跃数据源
           data_sources = self.compliance_service.get_active_data_sources()
           
           # 2. 检查每个数据源
           non_compliant_sources = []
           for ds in data_sources:
               result = self.compliance_service.check_compliance(ds)
               if result.status != "compliant":
                   non_compliant_sources.append((ds, result))
           
           # 3. 生成报告
           report = self._generate_report(non_compliant_sources)
           
           # 4. 发送通知
           self._send_notifications(report)
           
           # 5. 跟踪问题
           self._track_issues(non_compliant_sources)
       
       def _generate_report(self, non_compliant_sources: List) -> ComplianceReport:
           """生成合规性报告"""
           return ComplianceReport(
               date=datetime.utcnow(),
               total_sources=len(data_sources),
               compliant_count=len(data_sources) - len(non_compliant_sources),
               non_compliant_count=len(non_compliant_sources),
               critical_issues=sum(1 for _, r in non_compliant_sources if r.critical_issues > 0),
               details=non_compliant_sources
           )
       
       def _send_notifications(self, report: ComplianceReport):
           """发送通知"""
           # 发送给合规团队
           self.notification_service.send_email(
               to=self.config.compliance_team_email,
               subject=f"Daily Compliance Report - {report.date.strftime('%Y-%m-%d')}",
               body=self._format_report_email(report)
           )
           
           # 如果有关键问题，发送警报
           if report.critical_issues > 0:
               self.notification_service.send_slack_alert(
                   channel=self.config.alert_channel,
                   message=f"Critical compliance issues detected! {report.critical_issues} sources affected."
               )
       
       def _track_issues(self, non_compliant_sources: List):
           """跟踪合规性问题"""
           for ds, result in non_compliant_sources:
               # 创建或更新问题
               issue = self.compliance_service.get_issue(ds.id)
               if not issue:
                   self.compliance_service.create_issue(
                       data_source_id=ds.id,
                       description=result.suggestions[0] if result.suggestions else "Non-compliant data source",
                       severity="critical" if result.critical_issues > 0 else "high",
                       due_date=datetime.utcnow() + timedelta(days=7)
                   )
               else:
                   # 更新现有问题
                   self.compliance_service.update_issue(
                       issue.id,
                       status="open",
                       last_checked=datetime.utcnow()
                   )
   ```

---

## 📑 相关章节

| 前序 | 当前 | 后续 |
|-----|------|------|
| [9.4](ch9-4.md) | **9.5** | [9.6](ch9-6.md) |

**快速链接：**
- [← 返回第9章首頁](ch9-index.md)
