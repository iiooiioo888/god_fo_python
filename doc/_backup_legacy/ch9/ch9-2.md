<!-- LEGACY FILE NOTICE -->
> ⚠️ 此檔案為舊版備份，已被新檔取代： [ch9-2-详细功能清单.md](ch9-2-详细功能清单.md)\n> 備份時間：2025-10-31 12:28:27\n
---

**[← 返回第9章首頁](ch9-index.md)**

---

### 9.2 部署流程

#### 9.2.1 基础设施准备

1. **云资源准备**
   ```bash
   # 创建VPC网络
   aws ec2 create-vpc --cidr-block 10.0.0.0/16
   
   # 创建子网
   aws ec2 create-subnet --vpc-id vpc-123 --cidr-block 10.0.1.0/24 --availability-zone us-east-1a
   
   # 创建安全组
   aws ec2 create-security-group --group-name mirror-realm-sg --description "Mirror Realm Security Group"
   
   # 配置安全组规则
   aws ec2 authorize-security-group-ingress --group-id sg-123 --protocol tcp --port 80 --cidr 0.0.0.0/0
   aws ec2 authorize-security-group-ingress --group-id sg-123 --protocol tcp --port 443 --cidr 0.0.0.0/0
   aws ec2 authorize-security-group-ingress --group-id sg-123 --protocol tcp --port 8000-9000 --cidr 10.0.0.0/16
   ```

2. **Kubernetes集群创建**
   ```bash
   # 创建EKS集群
   eksctl create cluster \
     --name mirror-realm-prod \
     --region us-east-1 \
     --nodegroup-name standard-workers \
     --node-type t3.xlarge \
     --nodes 3 \
     --nodes-min 3 \
     --nodes-max 10 \
     --node-ami auto
   ```

#### 9.2.2 服务部署

1. **数据库部署**
   ```yaml
   # postgres-deployment.yaml
   apiVersion: apps/v1
   kind: StatefulSet
   metadata:
     name: postgres
   spec:
     serviceName: postgres
     replicas: 3
     selector:
       matchLabels:
         app: postgres
     template:
       metadata:
         labels:
           app: postgres
       spec:
         containers:
         - name: postgres
           image: postgres:13
           env:
           - name: POSTGRES_USER
             value: "mirror_realm"
           - name: POSTGRES_PASSWORD
             valueFrom:
               secretKeyRef:
                 name: db-secrets
                 key: password
           - name: POSTGRES_DB
             value: "mirror_realm"
           ports:
           - containerPort: 5432
           volumeMounts:
           - name: data
             mountPath: /var/lib/postgresql/data
         volumes:
         - name: data
           persistentVolumeClaim:
             claimName: postgres-pvc
   ---
   apiVersion: v1
   kind: Service
   metadata:
     name: postgres
   spec:
     ports:
     - port: 5432
       targetPort: 5432
     clusterIP: None
     selector:
       app: postgres
   ```

2. **微服务部署**
   ```yaml
   # dsr-deployment.yaml
   apiVersion: apps/v1
   kind: Deployment
   metadata:
     name: data-source-registry
   spec:
     replicas: 3
     selector:
       matchLabels:
         app: data-source-registry
     template:
       metadata:
         labels:
           app: data-source-registry
       spec:
         containers:
         - name: dsr
           image: mirror-realm/dsr:1.0.0
           ports:
           - containerPort: 8000
           env:
           - name: DB_HOST
             value: "postgres"
           - name: DB_PORT
             value: "5432"
           - name: DB_NAME
             value: "mirror_realm"
           - name: DB_USER
             value: "mirror_realm"
           - name: DB_PASSWORD
             valueFrom:
               secretKeyRef:
                 name: db-secrets
                 key: password
           resources:
             requests:
               memory: "512Mi"
               cpu: "500m"
             limits:
               memory: "1Gi"
               cpu: "1000m"
   ---
   apiVersion: v1
   kind: Service
   metadata:
     name: data-source-registry
   spec:
     type: ClusterIP
     ports:
     - port: 80
       targetPort: 8000
     selector:
       app: data-source-registry
   ```

#### 9.2.3 配置管理

1. **配置文件结构**
   ```
   config/
   ├── base/
   │   ├── application.yaml
   │   ├── database.yaml
   │   └── security.yaml
   ├── dev/
   │   ├── application.yaml
   │   └── overrides.yaml
   ├── staging/
   │   ├── application.yaml
   │   └── overrides.yaml
   └── prod/
       ├── application.yaml
       └── overrides.yaml
   ```

2. **配置管理服务实现**
   ```python
   import os
   import yaml
   from typing import Dict, Any
   import logging

   class ConfigManager:
       """配置管理器，加载和管理应用配置"""
       
       def __init__(self, env: str = "prod"):
           self.env = env
           self.logger = logging.getLogger(__name__)
           self.config = self._load_config()
       
       def _load_config(self) -> Dict[str, Any]:
           """加载配置"""
           # 1. 加载基础配置
           base_config = self._load_yaml("config/base/application.yaml")
           
           # 2. 加载环境特定配置
           env_config = self._load_yaml(f"config/{self.env}/application.yaml")
           
           # 3. 加载覆盖配置
           overrides = self._load_yaml(f"config/{self.env}/overrides.yaml")
           
           # 4. 合并配置
           config = self._deep_merge(base_config, env_config)
           config = self._deep_merge(config, overrides)
           
           # 5. 从环境变量覆盖
           config = self._apply_env_overrides(config)
           
           return config
       
       def _load_yaml(self, path: str) -> Dict:
           """加载YAML文件"""
           if not os.path.exists(path):
               self.logger.debug("Config file not found: %s", path)
               return {}
           
           with open(path, 'r') as f:
               return yaml.safe_load(f) or {}
       
       def _deep_merge(self, base: Dict, override: Dict) -> Dict:
           """深度合併配置"""
           result = base.copy()
           
           for key, value in override.items():
               if isinstance(value, dict) and key in result and isinstance(result[key], dict):
                   result[key] = self._deep_merge(result[key], value)
               else:
                   result[key] = value
           
           return result
       
       def _apply_env_overrides(self, config: Dict) -> Dict:
           """应用环境变量覆盖"""
           for key, value in os.environ.items():
               if key.startswith("APP_"):
                   # 转换为配置路径
                   config_path = key[4:].lower().replace('_', '.')
                   self._set_config_value(config, config_path, value)
           
           return config
       
       def _set_config_value(self, config: Dict, path: str, value: Any):
           """设置配置值"""
           keys = path.split('.')
           current = config
           
           for key in keys[:-1]:
               if key not in current or not isinstance(current[key], dict):
                   current[key] = {}
               current = current[key]
           
           # 转换值类型
           if isinstance(current[keys[-1]], bool):
               value = value.lower() == 'true'
           elif isinstance(current[keys[-1]], int):
               value = int(value)
           elif isinstance(current[keys[-1]], float):
               value = float(value)
           
           current[keys[-1]] = value
       
       def get(self, path: str, default: Any = None) -> Any:
           """获取配置值"""
           keys = path.split('.')
           current = self.config
           
           for key in keys:
               if key not in current:
                   return default
               current = current[key]
           
           return current
       
       def get_database_config(self) -> Dict:
           """获取数据库配置"""
           return {
               "host": self.get("database.host", "localhost"),
               "port": self.get("database.port", 5432),
               "name": self.get("database.name", "mirror_realm"),
               "user": self.get("database.user", "mirror_realm"),
               "password": os.getenv("DB_PASSWORD", "")
           }
   ```

---

## 📑 相关章节

| 前序 | 当前 | 后续 |
|-----|------|------|
| [9.1](ch9-1.md) | **9.2** | [9.3](ch9-3.md) |

**快速链接：**
- [← 返回第9章首頁](ch9-index.md)
