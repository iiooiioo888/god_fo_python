<!-- LEGACY FILE NOTICE -->
> âš ï¸ æ­¤æª”æ¡ˆç‚ºèˆŠç‰ˆå‚™ä»½ï¼Œå·²è¢«æ–°æª”å–ä»£ï¼š [ch8-8-å®‰å…¨è€ƒè™‘.md](ch8-8-å®‰å…¨è€ƒè™‘.md)\n> å‚™ä»½æ™‚é–“ï¼š2025-10-31 12:28:27\n
---

**[â† è¿”å›ç¬¬8ç« é¦–é ](ch8-index.md)**

---

### 8.8 å®‰å…¨è€ƒè™‘

#### 8.8.1 èŠ‚ç‚¹å®‰å…¨

1. **èŠ‚ç‚¹è®¤è¯ä¸æˆæƒ**
   ```python
   class NodeAuthenticator:
       """èŠ‚ç‚¹è®¤è¯å™¨"""
       
       def __init__(self, config: Config, db: Database):
           self.config = config
           self.db = db
           self.logger = logging.getLogger(__name__)
       
       def authenticate(
           self,
           node_id: str,
           token: str
       ) -> Tuple[bool, Optional[str]]:
           """
           è®¤è¯èŠ‚ç‚¹
           
           :param node_id: èŠ‚ç‚¹ID
           :param token: è®¤è¯ä»¤ç‰Œ
           :return: (æ˜¯å¦è®¤è¯é€šè¿‡, é”™è¯¯æ¶ˆæ¯)
           """
           # 1. æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨
           node = self._get_node(node_id)
           if not node:
               return False, "Node not registered"
           
           # 2. æ£€æŸ¥ä»¤ç‰Œæœ‰æ•ˆæ€§
           if not self._validate_token(node, token):
               return False, "Invalid token"
           
           # 3. æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
           if node["status"] != "online":
               return False, f"Node not online (status: {node['status']})"
           
           return True, None
       
       def _get_node(self, node_id: str) -> Optional[Dict]:
           """è·å–èŠ‚ç‚¹ä¿¡æ¯"""
           sql = "SELECT * FROM crawler_nodes WHERE id = %(id)s"
           return self.db.fetchone(sql, {"id": node_id})
       
       def _validate_token(self, node: Dict, token: str) -> bool:
           """éªŒè¯ä»¤ç‰Œ"""
           # 1. æ£€æŸ¥ä»¤ç‰Œæ ¼å¼
           if not re.match(r'^[a-f0-9]{64}$', token):
               return False
           
           # 2. æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦åŒ¹é…
           stored_token = node["auth_token"]
           return hmac.compare_digest(stored_token, token)
       
       def generate_token(self, node_id: str) -> str:
           """ç”ŸæˆèŠ‚ç‚¹è®¤è¯ä»¤ç‰Œ"""
           # 1. ç”Ÿæˆéšæœºä»¤ç‰Œ
           token = secrets.token_hex(32)
           
           # 2. å­˜å‚¨ä»¤ç‰Œï¼ˆå“ˆå¸Œåï¼‰
           hashed_token = self._hash_token(token)
           self._store_token(node_id, hashed_token)
           
           return token
       
       def _hash_token(self, token: str) -> str:
           """å“ˆå¸Œä»¤ç‰Œ"""
           return hashlib.sha256(token.encode('utf-8')).hexdigest()
       
       def _store_token(self, node_id: str, hashed_token: str):
           """å­˜å‚¨å“ˆå¸Œä»¤ç‰Œ"""
           sql = """
           UPDATE crawler_nodes 
           SET auth_token = %(token)s, auth_token_updated = NOW()
           WHERE id = %(id)s
           """
           self.db.execute(sql, {
               "id": node_id,
               "token": hashed_token
           })
   ```

2. **èŠ‚ç‚¹æ²™ç®±ç¯å¢ƒ**
   ```python
   class NodeSandbox:
       """èŠ‚ç‚¹æ²™ç®±ç¯å¢ƒï¼Œé™åˆ¶çˆ¬è™«æ‰§è¡Œ"""
       
       def __init__(self, config: Config):
           self.config = config
           self.logger = logging.getLogger(__name__)
       
       def create_sandbox(self, node_id: str, task: CrawlerTask) -> str:
           """
           åˆ›å»ºæ²™ç®±ç¯å¢ƒ
           
           :param node_id: èŠ‚ç‚¹ID
           :param task: ä»»åŠ¡
           :return: æ²™ç®±è·¯å¾„
           """
           # 1. åˆ›å»ºä¸´æ—¶ç›®å½•
           sandbox_dir = tempfile.mkdtemp(prefix=f"sandbox_{node_id}_")
           
           # 2. è®¾ç½®èµ„æºé™åˆ¶
           self._apply_resource_limits(sandbox_dir, task)
           
           # 3. è®¾ç½®ç½‘ç»œé™åˆ¶
           self._apply_network_limits(sandbox_dir, task)
           
           # 4. è®¾ç½®æ–‡ä»¶ç³»ç»Ÿé™åˆ¶
           self._apply_filesystem_limits(sandbox_dir, task)
           
           return sandbox_dir
       
       def _apply_resource_limits(self, sandbox_dir: str, task: CrawlerTask):
           """åº”ç”¨èµ„æºé™åˆ¶"""
           # ä½¿ç”¨cgroupsé™åˆ¶èµ„æº
           cgroup_path = f"/sys/fs/cgroup/crawler/{task.id}"
           os.makedirs(cgroup_path, exist_ok=True)
           
           # CPUé™åˆ¶
           cpu_quota = int(self.config.cpu_quota_base * task.min_resources.get("cpu_cores", 1))
           with open(f"{cgroup_path}/cpu.max", "w") as f:
               f.write(f"{cpu_quota} 100000")
           
           # å†…å­˜é™åˆ¶
           mem_limit = task.min_resources.get("memory_mb", 1024) * 1024 * 1024
           with open(f"{cgroup_path}/memory.max", "w") as f:
               f.write(str(mem_limit))
       
       def _apply_network_limits(self, sandbox_dir: str, task: CrawlerTask):
           """åº”ç”¨ç½‘ç»œé™åˆ¶"""
           # ä½¿ç”¨network namespaceéš”ç¦»
           netns_name = f"crawler_{task.id}"
           subprocess.run(["ip", "netns", "add", netns_name], check=True)
           
           # è®¾ç½®ç½‘ç»œé™åˆ¶
           if task.min_resources.get("network_bandwidth_mbps"):
               bandwidth = task.min_resources["network_bandwidth_mbps"]
               subprocess.run([
                   "tc", "qdisc", "add", "dev", "eth0", "root", "tbf", 
                   "rate", f"{bandwidth}mbit", "burst", "50kb", "latency", "70ms"
               ], check=True)
       
       def _apply_filesystem_limits(self, sandbox_dir: str, task: CrawlerTask):
           """åº”ç”¨æ–‡ä»¶ç³»ç»Ÿé™åˆ¶"""
           # ä½¿ç”¨bind mounté™åˆ¶æ–‡ä»¶ç³»ç»Ÿè®¿é—®
           allowed_dirs = self.config.sandbox_allowed_dirs
           for src, dest in allowed_dirs.items():
               os.makedirs(f"{sandbox_dir}{dest}", exist_ok=True)
               subprocess.run([
                   "mount", "-o", "bind", src, f"{sandbox_dir}{dest}"
               ], check=True)
           
           # åªæ­¢å…¶ä»–æ–‡ä»¶ç³»ç»Ÿè®¿é—®
           subprocess.run([
               "mount", "-o", "remount,ro", "proc", f"{sandbox_dir}/proc"
           ], check=True)
       
       def cleanup_sandbox(self, sandbox_dir: str):
           """æ¸…ç†æ²™ç®±ç¯å¢ƒ"""
           # 1. åˆ é™¤cgroup
           cgroup_path = f"/sys/fs/cgroup/crawler/{os.path.basename(sandbox_dir)}"
           if os.path.exists(cgroup_path):
               shutil.rmtree(cgroup_path)
           
           # 2. åˆ é™¤network namespace
           netns_name = f"crawler_{os.path.basename(sandbox_dir)}"
           subprocess.run(["ip", "netns", "delete", netns_name], check=False)
           
           # 3. åˆ é™¤ä¸´æ—¶ç›®å½•
           if os.path.exists(sandbox_dir):
               shutil.rmtree(sandbox_dir)
   ```

---

## ğŸ“‘ ç›¸å…³ç« èŠ‚

| å‰åº | å½“å‰ | åç»­ |
|-----|------|------|
| [8.7](ch8-7.md) | **8.8** | [8.9](ch8-9.md) |

**å¿«é€Ÿé“¾æ¥ï¼š**
- [â† è¿”å›ç¬¬8ç« é¦–é ](ch8-index.md)
