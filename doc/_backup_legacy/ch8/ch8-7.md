<!-- LEGACY FILE NOTICE -->
> âš ï¸ æ­¤æª”æ¡ˆç‚ºèˆŠç‰ˆå‚™ä»½ï¼Œå·²è¢«æ–°æª”å–ä»£ï¼š [ch8-7-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥.md](ch8-7-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥.md)\n> å‚™ä»½æ™‚é–“ï¼š2025-10-31 12:28:26\n
---

**[â† è¿”å›ç¬¬8ç« é¦–é ](ch8-index.md)**

---

### 8.7 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 8.7.1 ä»»åŠ¡è°ƒåº¦ä¼˜åŒ–

1. **åˆ†å±‚ä»»åŠ¡é˜Ÿåˆ—**
   ```python
   class LayeredTaskQueue:
       """åˆ†å±‚ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ”¯æŒä¼˜å…ˆçº§å’Œåˆ†ç±»"""
       
       def __init__(self, config: Config):
           self.config = config
           self.logger = logging.getLogger(__name__)
           
           # åˆ›å»ºä¼˜å…ˆçº§é˜Ÿåˆ—
           self.priority_queues = {
               priority: PriorityQueue()
               for priority in range(1, 11)  # 1-10ä¼˜å…ˆçº§
           }
           
           # åˆ›å»ºç±»åˆ«é˜Ÿåˆ—
           self.category_queues = defaultdict(PriorityQueue)
       
       def add_task(self, task: CrawlerTask):
           """æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—"""
           # æŒ‰ä¼˜å…ˆçº§æ·»åŠ 
           self.priority_queues[task.priority].put((task.created_at, task.id, task))
           
           # æŒ‰ç±»åˆ«æ·»åŠ 
           for category in task.categories:
               self.category_queues[category].put((task.priority, task.created_at, task.id, task))
       
       def get_next_task(
           self,
           max_priority: int = 10,
           categories: Optional[List[str]] = None
       ) -> Optional[CrawlerTask]:
           """è·å–ä¸‹ä¸€ä¸ªä»»åŠ¡"""
           # 1. æŒ‰ç±»åˆ«è·å–ä»»åŠ¡
           if categories:
               for category in categories:
                   if category in self.category_queues:
                       task = self._get_task_from_category_queue(category)
                       if task and task.priority <= max_priority:
                           return task
           
           # 2. æŒ‰ä¼˜å…ˆçº§è·å–ä»»åŠ¡
           for priority in range(1, max_priority + 1):
               if not self.priority_queues[priority].empty():
                   _, _, task = self.priority_queues[priority].get()
                   return task
           
           return None
       
       def _get_task_from_category_queue(self, category: str) -> Optional[CrawlerTask]:
           """ä»ç±»åˆ«é˜Ÿåˆ—è·å–ä»»åŠ¡"""
           if self.category_queues[category].empty():
               return None
           
           # è·å–æœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡
           _, _, _, task = self.category_queues[category].get()
           return task
       
       def task_completed(self, task: CrawlerTask):
           """ä»»åŠ¡å®Œæˆå¤„ç†"""
           # ä»é˜Ÿåˆ—ä¸­ç§»é™¤
           self._remove_from_priority_queue(task)
           self._remove_from_category_queues(task)
       
       def _remove_from_priority_queue(self, task: CrawlerTask):
           """ä»ä¼˜å…ˆçº§é˜Ÿåˆ—ç§»é™¤"""
           # ç®€å•å®ç°ï¼šé‡å»ºé˜Ÿåˆ—
           temp_queue = PriorityQueue()
           while not self.priority_queues[task.priority].empty():
               t = self.priority_queues[task.priority].get()
               if t[2].id != task.id:
                   temp_queue.put(t)
           self.priority_queues[task.priority] = temp_queue
       
       def _remove_from_category_queues(self, task: CrawlerTask):
           """ä»ç±»åˆ«é˜Ÿåˆ—ç§»é™¤"""
           for category in task.categories:
               if category in self.category_queues:
                   # é‡å»ºç±»åˆ«é˜Ÿåˆ—
                   temp_queue = PriorityQueue()
                   while not self.category_queues[category].empty():
                       t = self.category_queues[category].get()
                       if t[3].id != task.id:
                           temp_queue.put(t)
                   self.category_queues[category] = temp_queue
   ```

2. **æ‰¹é‡ä»»åŠ¡åˆ†é…**
   ```python
   class BatchTaskScheduler:
       """æ‰¹é‡ä»»åŠ¡è°ƒåº¦å™¨ï¼Œæé«˜è°ƒåº¦æ•ˆç‡"""
       
       def __init__(self, config: Config, node_manager: CrawlerNodeManager):
           self.config = config
           self.node_manager = node_manager
           self.logger = logging.getLogger(__name__)
       
       def schedule_batch(
           self,
           tasks: List[CrawlerTask],
           nodes: List[NodeInfo]
       ) -> Dict[str, List[CrawlerTask]]:
           """
           æ‰¹é‡è°ƒåº¦ä»»åŠ¡
           
           :param tasks: ä»»åŠ¡åˆ—è¡¨
           :param nodes: å¯ç”¨èŠ‚ç‚¹åˆ—è¡¨
           :return: èŠ‚ç‚¹åˆ°ä»»åŠ¡çš„æ˜ å°„
           """
           # 1. æŒ‰ç­–ç•¥å¯¹ä»»åŠ¡æ’åº
           sorted_tasks = self._sort_tasks(tasks)
           
           # 2. æŒ‰èƒ½åŠ›å¯¹èŠ‚ç‚¹æ’åº
           sorted_nodes = self._sort_nodes(nodes)
           
           # 3. åˆ†é…ä»»åŠ¡
           assignment = {node.id: [] for node in sorted_nodes}
           node_index = 0
           
           for task in sorted_tasks:
               # é€‰æ‹©èŠ‚ç‚¹ï¼ˆè½®è¯¢ï¼‰
               node = sorted_nodes[node_index]
               assignment[node.id].append(task)
               
               # æ›´æ–°ç´¢å¼•
               node_index = (node_index + 1) % len(sorted_nodes)
           
           return assignment
       
       def _sort_tasks(self, tasks: List[CrawlerTask]) -> List[CrawlerTask]:
           """å¯¹ä»»åŠ¡æ’åº"""
           # æŒ‰ä¼˜å…ˆçº§å’Œåˆ›å»ºæ—¶é—´æ’åº
           return sorted(
               tasks,
               key=lambda t: (-t.priority, t.created_at)
           )
       
       def _sort_nodes(self, nodes: List[NodeInfo]) -> List[NodeInfo]:
           """å¯¹èŠ‚ç‚¹æ’åº"""
           # æŒ‰è´Ÿè½½æ’åºï¼ˆå‡åºï¼‰
           return sorted(
               nodes,
               key=lambda n: n.load
           )
   ```

#### 8.7.2 èµ„æºä¼˜åŒ–

1. **åŠ¨æ€èµ„æºåˆ†é…**
   ```python
   class DynamicResourceAllocator:
       """åŠ¨æ€èµ„æºåˆ†é…å™¨"""
       
       def __init__(self, config: Config):
           self.config = config
           self.logger = logging.getLogger(__name__)
       
       def allocate_resources(
           self,
           task: CrawlerTask,
           node: NodeInfo
       ) -> Dict[str, Any]:
           """
           åˆ†é…èµ„æºç»™ä»»åŠ¡
           
           :param task: ä»»åŠ¡
           :param node: èŠ‚ç‚¹
           :return: èµ„æºåˆ†é…ç»“æœ
           """
           # 1. åŸºå§‹åˆ†é…
           allocation = self._initial_allocation(task, node)
           
           # 2. æ ¹æ®å®æ—¶è´Ÿè½½è°ƒæ•´
           allocation = self._adjust_for_load(allocation, node)
           
           # 3. æ ¹æ®ä»»åŠ¡ç‰¹æ€§è°ƒæ•´
           allocation = self._adjust_for_task(allocation, task)
           
           return allocation
       
       def _initial_allocation(
           self,
           task: CrawlerTask,
           node: NodeInfo
       ) -> Dict[str, Any]:
           """åˆå§‹èµ„æºåˆ†é…"""
           # åŸºå§‹åˆ†é…åŸºäºä»»åŠ¡è¯·æ±‚
           allocation = {
               "cpu_cores": min(task.min_resources.get("cpu_cores", 1), node.resources["cpu"]),
               "memory_mb": min(task.min_resources.get("memory_mb", 1024), node.resources["memory_mb"]),
               "gpu": min(task.min_resources.get("gpu", 0), node.resources["gpu"])
           }
           
           # ç¡®ä¿è‡³å°‘åˆ†é…æœ€å°èµ„æº
           allocation["cpu_cores"] = max(allocation["cpu_cores"], 0.5)
           allocation["memory_mb"] = max(allocation["memory_mb"], 512)
           
           return allocation
       
       def _adjust_for_load(
           self,
           allocation: Dict[str, Any],
           node: NodeInfo
       ) -> Dict[str, Any]:
           """æ ¹æ®èŠ‚ç‚¹è´Ÿè½½è°ƒæ•´èµ„æºåˆ†é…"""
           # å¦‚æœèŠ‚ç‚¹è´Ÿè½½é«˜ï¼Œå‡å°‘èµ„æºåˆ†é…
           if node.load > 0.7:
               allocation["cpu_cores"] *= 0.8
               allocation["memory_mb"] *= 0.9
           
           # å¦‚æœèŠ‚ç‚¹è´Ÿè½½ä½ï¼Œå¢åŠ èµ„æºåˆ†é…
           elif node.load < 0.3:
               allocation["cpu_cores"] = min(allocation["cpu_cores"] * 1.2, node.resources["cpu"])
               allocation["memory_mb"] = min(allocation["memory_mb"] * 1.1, node.resources["memory_mb"])
           
           return allocation
       
       def _adjust_for_task(
           self,
           allocation: Dict[str, Any],
           task: CrawlerTask
       ) -> Dict[str, Any]:
           """æ ¹æ®ä»»åŠ¡ç‰¹æ€§è°ƒæ•´èµ„æºåˆ†é…"""
           # å¦‚æœä»»åŠ¡éœ€è¦JavaScriptæ¸²æŸ“ï¼Œå¢åŠ å†…å­˜
           if task.capabilities.get("javascript_rendering", 0) > 0:
               allocation["memory_mb"] = min(allocation["memory_mb"] * 1.5, 8192)
           
           # å¦‚æœä»»åŠ¡éœ€è¦ä»£ç†è½®æ¢ï¼Œå¢åŠ CPU
           if task.capabilities.get("proxy_rotation", 0) > 0:
               allocation["cpu_cores"] = min(allocation["cpu_cores"] * 1.3, 4.0)
           
           return allocation
   ```

---

## ğŸ“‘ ç›¸å…³ç« èŠ‚

| å‰åº | å½“å‰ | åç»­ |
|-----|------|------|
| [8.6](ch8-6.md) | **8.7** | [8.8](ch8-8.md) |

**å¿«é€Ÿé“¾æ¥ï¼š**
- [â† è¿”å›ç¬¬8ç« é¦–é ](ch8-index.md)
