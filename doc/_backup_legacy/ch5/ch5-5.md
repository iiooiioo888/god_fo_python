<!-- LEGACY FILE NOTICE -->
> ‚ö†Ô∏è Ê≠§Ê™îÊ°àÁÇ∫ËàäÁâàÂÇô‰ªΩÔºåÂ∑≤Ë¢´Êñ∞Ê™îÂèñ‰ª£Ôºö [ch5-5-Êï∞ÊçÆÊ®°ÂûãËØ¶ÁªÜÂÆö‰πâ.md](ch5-5-Êï∞ÊçÆÊ®°ÂûãËØ¶ÁªÜÂÆö‰πâ.md)\n> ÂÇô‰ªΩÊôÇÈñìÔºö2025-10-31 12:28:26\n
---

**[‚Üê ËøîÂõûÁ¨¨5Á´†È¶ñÈ†Å](ch5-index.md)**

---

### 5.5 Êï∞ÊçÆÊ®°ÂûãËØ¶ÁªÜÂÆö‰πâ

#### 5.5.1 Â™í‰ΩìÊñá‰ª∂Ë°®

```sql
-- Â™í‰ΩìÊñá‰ª∂ÂÖÉÊï∞ÊçÆË°®
CREATE TABLE media_files (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    source_id UUID REFERENCES data_sources(id) ON DELETE SET NULL,
    workflow_instance_id UUID REFERENCES workflow_instances(id) ON DELETE SET NULL,
    path VARCHAR(1024) NOT NULL,
    filename VARCHAR(255) NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    size BIGINT NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    processed_at TIMESTAMPTZ,
    status VARCHAR(20) NOT NULL DEFAULT 'raw' CHECK (status IN ('raw', 'processing', 'processed', 'failed', 'archived')),
    original_id UUID REFERENCES media_files(id) ON DELETE SET NULL,
    version INT NOT NULL DEFAULT 1,
    metadata JSONB DEFAULT '{}'::jsonb,
    exif JSONB DEFAULT '{}'::jsonb,
    ai_analysis JSONB DEFAULT '{}'::jsonb,
    
    -- Á¥¢Âºï
    UNIQUE (project_id, path, version),
    INDEX idx_media_files_project ON media_files(project_id),
    INDEX idx_media_files_source ON media_files(source_id),
    INDEX idx_media_files_status ON media_files(status),
    INDEX idx_media_files_created ON media_files(created_at DESC),
    INDEX idx_media_files_processed ON media_files(processed_at DESC),
    
    -- ÂÖ®ÊñáÊêúÁ¥¢
    ts_vector TSVECTOR GENERATED ALWAYS AS (
        to_tsvector('simple', coalesce(filename, '') || ' ' || coalesce(metadata->>'title', '') || ' ' || coalesce(metadata->>'description', ''))
    ) STORED
);

-- Ëá™Âä®Êõ¥Êñ∞updated_atËß¶ÂèëÂô®
CREATE OR REPLACE FUNCTION update_media_files_modtime()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_media_files_modtime
BEFORE UPDATE ON media_files
FOR EACH ROW
EXECUTE FUNCTION update_media_files_modtime();

-- ÂÖ®ÊñáÊêúÁ¥¢Á¥¢Âºï
CREATE INDEX idx_media_files_search ON media_files USING GIN (ts_vector);
```

#### 5.5.2 Â™í‰ΩìÂ§ÑÁêÜ‰ªªÂä°Ë°®

```sql
-- Â™í‰ΩìÂ§ÑÁêÜ‰ªªÂä°Ë°®
CREATE TABLE media_processing_tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    file_id UUID NOT NULL REFERENCES media_files(id) ON DELETE CASCADE,
    task_type VARCHAR(50) NOT NULL,
    parameters JSONB NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'running', 'completed', 'failed', 'canceled')),
    priority INT NOT NULL DEFAULT 5,
    queued_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    duration INTERVAL,
    worker_id VARCHAR(255),
    input_path VARCHAR(1024),
    output_path VARCHAR(1024),
    error JSONB,
    retry_count INT NOT NULL DEFAULT 0,
    max_retries INT NOT NULL DEFAULT 3,
    resource_requirements JSONB DEFAULT '{}'::jsonb,
    
    -- Á¥¢Âºï
    INDEX idx_tasks_file ON media_processing_tasks(file_id),
    INDEX idx_tasks_status ON media_processing_tasks(status),
    INDEX idx_tasks_priority ON media_processing_tasks(priority, queued_at),
    INDEX idx_tasks_worker ON media_processing_tasks(worker_id),
    INDEX idx_tasks_queued ON media_processing_tasks(queued_at)
);
```

#### 5.5.3 Â™í‰ΩìÊ†áÁ≠æË°®

```sql
-- Â™í‰ΩìÊ†áÁ≠æË°®
CREATE TABLE media_tags (
    file_id UUID NOT NULL REFERENCES media_files(id) ON DELETE CASCADE,
    tag_type VARCHAR(50) NOT NULL,
    tag_value VARCHAR(255) NOT NULL,
    confidence NUMERIC(4,2) NOT NULL,
    source VARCHAR(50) NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    
    PRIMARY KEY (file_id, tag_type, tag_value),
    INDEX idx_tags_file ON media_tags(file_id),
    INDEX idx_tags_type ON media_tags(tag_type),
    INDEX idx_tags_value ON media_tags(tag_value)
);
```

#### 5.5.4 Â™í‰ΩìÁõ∏‰ª•Â∫¶Ë°®

```sql
-- Â™í‰ΩìÁõ∏‰ª•Â∫¶Ë°® (Áî®‰∫éÊü•ÊâæÁõ∏‰ª•ÂõæÁâá)
CREATE TABLE media_similarity (
    file_id1 UUID NOT NULL REFERENCES media_files(id) ON DELETE CASCADE,
    file_id2 UUID NOT NULL REFERENCES media_files(id) ON DELETE CASCADE,
    similarity_score NUMERIC(5,4) NOT NULL,
    algorithm VARCHAR(50) NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    
    PRIMARY KEY (file_id1, file_id2, algorithm),
    CHECK (file_id1 < file_id2),  -- ÈÅøÂÖçÈáçÂ§çÂ≠òÂÇ®
    INDEX idx_similarity_score ON media_similarity(similarity_score DESC),
    INDEX idx_similarity_file1 ON media_similarity(file_id1)
);
```

---

## üìë Áõ∏ÂÖ≥Á´†ËäÇ

| ÂâçÂ∫è | ÂΩìÂâç | ÂêéÁª≠ |
|-----|------|------|
| [5.4](ch5-4.md) | **5.5** | [5.6](ch5-6.md) |

**Âø´ÈÄüÈìæÊé•Ôºö**
- [‚Üê ËøîÂõûÁ¨¨5Á´†È¶ñÈ†Å](ch5-index.md)
