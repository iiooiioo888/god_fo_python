<!-- LEGACY FILE NOTICE -->
> âš ï¸ æ­¤æª”æ¡ˆç‚ºèˆŠç‰ˆå‚™ä»½ï¼Œå·²è¢«æ–°æª”å–ä»£ï¼š [ch5-8-å®‰å…¨ä¸åˆè§„.md](ch5-8-å®‰å…¨ä¸åˆè§„.md)\n> å‚™ä»½æ™‚é–“ï¼š2025-10-31 12:28:26\n
---

**[â† è¿”å›ç¬¬5ç« é¦–é ](ch5-index.md)**

---

### 5.8 å®‰å…¨ä¸åˆè§„è¯¦ç»†è§„èŒƒ

#### 5.8.1 æ•æ„Ÿæ•°æ®æ£€æµ‹ä¸è„±æ•è§„åˆ™

**æ•æ„Ÿæ•°æ®æ­£åˆ™è¡¨è¾¾å¼è§„åˆ™åº“**
```json
{
  "patterns": [
    {
      "id": "credit-card",
      "name": "ä¿¡ç”¨å¡å·",
      "description": "æ£€æµ‹å„ç§ä¿¡ç”¨å¡å·æ ¼å¼",
      "regex": "(?:\\d[ -]*?){13,16}",
      "confidence": 0.9,
      "redaction": "****-****-****-XXXX",
      "validation": {
        "luhn_check": true
      },
      "allowed_contexts": ["payment", "billing"]
    },
    {
      "id": "ssn",
      "name": "ç¤¾ä¼šå®‰å…¨å·ç ",
      "description": "ç¾å›½ç¤¾ä¼šå®‰å…¨å·ç  (æ ¼å¼: XXX-XX-XXXX)",
      "regex": "\\b\\d{3}[- ]?\\d{2}[- ]?\\d{4}\\b",
      "confidence": 0.95,
      "redaction": "***-**-XXXX",
      "allowed_contexts": ["identity-verification"]
    },
    {
      "id": "email",
      "name": "ç”µå­é‚®ä»¶åœ°å€",
      "description": "æ ‡å‡†ç”µå­é‚®ä»¶æ ¼å¼",
      "regex": "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}",
      "confidence": 0.8,
      "redaction": "userXXXX@example.com",
      "allowed_contexts": ["communication", "user-profile"]
    },
    {
      "id": "phone",
      "name": "ç”µè¯å·ç ",
      "description": "å›½é™…ç”µè¯å·ç æ ¼å¼",
      "regex": "(?:\\+?1[-. ]?)?\\(?\\d{3}\\)?[-. ]?\\d{3}[-. ]?\\d{4}",
      "confidence": 0.75,
      "redaction": "(XXX) XXX-XXXX",
      "allowed_contexts": ["contact", "user-profile"]
    },
    {
      "id": "passport",
      "name": "æŠ¤ç…§å·ç ",
      "description": "é€šç”¨æŠ¤ç…§å·ç æ ¼å¼",
      "regex": "[A-Z0-9]{6,9}",
      "confidence": 0.7,
      "redaction": "XXXXXX",
      "allowed_contexts": ["travel", "identity-verification"],
      "validation": {
        "country_specific": true
      }
    }
  ],
  "context_rules": [
    {
      "context": "payment",
      "allowed_patterns": ["credit-card"],
      "required_validation": ["luhn_check"]
    },
    {
      "context": "identity-verification",
      "allowed_patterns": ["ssn", "passport"],
      "required_validation": ["document_verification"]
    }
  ]
}
```

#### 5.8.2 æ•°æ®å¤„ç†å®‰å…¨ä¸­é—´ä»¶å®ç°

**æ•°æ®å®‰å…¨ä¸­é—´ä»¶ (data_security_middleware.py)**
```python
import re
import json
from typing import Dict, List, Optional, Callable, Any
from functools import wraps
import logging

class DataSecurityMiddleware:
    """
    æ•°æ®å®‰å…¨ä¸­é—´ä»¶ï¼Œè´Ÿè´£æ•æ„Ÿæ•°æ®æ£€æµ‹ä¸è„±æ•
    """
    
    def __init__(self, config_path: str = "security_rules.json"):
        self.logger = logging.getLogger(__name__)
        self.rules = self._load_rules(config_path)
        self.context_stack = []
    
    def _load_rules(self, config_path: str) -> Dict:
        """åŠ è½½å®‰å…¨è§„åˆ™"""
        try:
            with open(config_path, 'r') as f:
                return json.load(f)
        except Exception as e:
            self.logger.error("Failed to load security rules: %s", str(e))
            # ä½¿ç”¨é»˜è®¤è§„åˆ™
            return {
                "patterns": [],
                "context_rules": []
            }
    
    def enter_context(self, context: str):
        """è¿›å…¥ç‰¹å®šå®‰å…¨ä¸Šä¸‹æ–‡"""
        self.context_stack.append(context)
    
    def exit_context(self):
        """é€€å‡ºå½“å‰å®‰å…¨ä¸Šä¸‹æ–‡"""
        if self.context_stack:
            self.context_stack.pop()
    
    def get_current_context(self) -> Optional[str]:
        """è·å–å½“å‰å®‰å…¨ä¸Šä¸‹æ–‡"""
        return self.context_stack[-1] if self.context_stack else None
    
    def _is_pattern_allowed(self, pattern_id: str, context: Optional[str]) -> bool:
        """æ£€æŸ¥æ¨¡å¼æ˜¯å¦åœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­å…è®¸ä½¿ç”¨"""
        if not context:
            return False
            
        context_rule = next(
            (r for r in self.rules["context_rules"] if r["context"] == context),
            None
        )
        
        if not context_rule:
            return False
            
        return pattern_id in context_rule["allowed_patterns"]
    
    def _validate_pattern(self, pattern_id: str, value: str) -> bool:
        """éªŒè¯æ•æ„Ÿæ•°æ®æ¨¡å¼"""
        pattern = next(
            (p for p in self.rules["patterns"] if p["id"] == pattern_id),
            None
        )
        
        if not pattern or "validation" not in pattern:
            return True
            
        # Luhnç®—æ³•éªŒè¯ (ä¿¡ç”¨å¡)
        if pattern["id"] == "credit-card" and pattern["validation"].get("luhn_check"):
            return self._validate_luhn(value)
            
        return True
    
    def _validate_luhn(self, card_number: str) -> bool:
        """éªŒè¯ä¿¡ç”¨å¡å·æ˜¯å¦é€šè¿‡Luhnç®—æ³•"""
        # æ¸…ç†éæ•°å­—å­—ç¬¦
        digits = re.sub(r"[^\d]", "", card_number)
        
        # æª¢æŸ¥é•¿åº¦
        if len(digits) < 13 or len(digits) > 16:
            return False
            
        # Luhnç®—æ³•
        total = 0
        reverse = digits[::-1]
        
        for i, digit in enumerate(reverse):
            n = int(digit)
            if i % 2 == 1:
                n *= 2
                if n > 9:
                    n -= 9
            total += n
            
        return total % 10 == 0
    
    def _redact_value(self, pattern_id: str, value: str) -> str:
        """æ ¹æ®è§„åˆ™è„±æ•å€¼"""
        pattern = next(
            (p for p in self.rules["patterns"] if p["id"] == pattern_id),
            None
        )
        
        if not pattern or "redaction" not in pattern:
            return value
            
        # ç®€å•å®ç°ï¼šæ ¹æ®è§„åˆ™æ›¿æ¢
        if "XXXX" in pattern["redaction"]:
            # ä¿ç•™æœ«å°¾å‡ ä½
            last_digits = pattern["redaction"].count("X")
            return pattern["redaction"].replace("X" * last_digits, value[-last_digits:])
            
        return pattern["redaction"]
    
    def detect_sensitive_data(self, data: Any, context: Optional[str] = None) -> List[Dict]:
        """
        æ£€æµ‹æ•°æ®ä¸­çš„æ•æ„Ÿä¿¡æ¯
        
        :param data: è¦æ£€æµ‹çš„æ•°æ® (å¯ä»¥æ˜¯å­—ç¬¦ä¸²ã€å­—å…¸ã€åˆ—è¡¨)
        :param context: å®‰å…¨ä¸Šä¸‹æ–‡
        :return: æ£€æµ‹åˆ°çš„æ•æ„Ÿæ•°æ®åˆ—è¡¨
        """
        results = []
        
        if isinstance(data, str):
            for pattern in self.rules["patterns"]:
                matches = re.finditer(pattern["regex"], data)
                for match in matches:
                    value = match.group(0)
                    
                    # éªŒè¯æ¨¡å¼ (å¦‚æœéœ€è¦)
                    if not self._validate_pattern(pattern["id"], value):
                        continue
                        
                    results.append({
                        "pattern_id": pattern["id"],
                        "value": value,
                        "start": match.start(),
                        "end": match.end(),
                        "confidence": pattern["confidence"],
                        "allowed": self._is_pattern_allowed(pattern["id"], context or self.get_current_context())
                    })
                    
        elif isinstance(data, dict):
            for key, value in data.items():
                # æª¢æŸ¥é”®åæ˜¯å¦æš—ç¤ºæ•æ„Ÿæ•°æ®
                if any(kw in key.lower() for kw in ["ssn", "social", "security", "credit", "card", "passport"]):
                    # é€’å½’æ£€æµ‹å€¼
                    sub_results = self.detect_sensitive_data(value, context)
                    for r in sub_results:
                        r["path"] = f"{key}.{r.get('path', '')}".rstrip('.')
                        results.append(r)
                
                # æ£€æµ‹å€¼
                sub_results = self.detect_sensitive_data(value, context)
                for r in sub_results:
                    r["path"] = f"{key}.{r.get('path', '')}".rstrip('.')
                    results.append(r)
                    
        elif isinstance(data, list):
            for i, item in enumerate(data):
                sub_results = self.detect_sensitive_data(item, context)
                for r in sub_results:
                    r["path"] = f"[{i}].{r.get('path', '')}".rstrip('.')
                    results.append(r)
                    
        return results
    
    def redact_sensitive_data(self,  Any, context: Optional[str] = None) -> Any:
        """
        è„±æ•æ•°æ®ä¸­çš„æ•æ„Ÿä¿¡æ¯
        
        :param  è¦è„±æ•çš„æ•°æ®
        :param context: å®‰å…¨ä¸Šä¸‹æ–‡
        :return: è„±æ•åçš„æ•°æ®
        """
        current_context = context or self.get_current_context()
        
        if isinstance(data, str):
            # æ£€æµ‹æ‰€æœ‰æ•æ„Ÿæ•°æ®
            detections = self.detect_sensitive_data(data, current_context)
            
            # æŒ‰ä½ç½®æ’åºï¼Œä»åå¾€å‰æ›¿æ¢ (é¿å…ä½ç½®åç§»)
            detections.sort(key=lambda x: x["start"], reverse=True)
            
            result = data
            for detection in detections:
                if not detection["allowed"]:
                    # æ‰§è¡Œè„±æ•
                    redacted = self._redact_value(detection["pattern_id"], detection["value"])
                    result = result[:detection["start"]] + redacted + result[detection["end"]:]
            
            return result
            
        elif isinstance(data, dict):
            result = {}
            for key, value in data.items():
                # æª¢æŸ¥é”®åæ˜¯å¦éœ€è¦ç‰¹æ®Šå¤„ç†
                if any(kw in key.lower() for kw in ["ssn", "social", "security", "credit", "card", "passport"]):
                    # é”®åæš—ç¤ºæ•æ„Ÿæ•°æ®ï¼Œè„±æ•æ•´ä¸ªå€¼
                    result[key] = self.redact_sensitive_data(value, current_context)
                else:
                    # é€’å½’è„±æ•
                    result[key] = self.redact_sensitive_data(value, current_context)
            return result
            
        elif isinstance(data, list):
            return [self.redact_sensitive_data(item, current_context) for item in data]
            
        return data
    
    def audit_log(self, operation: str, data: Any, context: Optional[str] = None):
        """
        è®°å½•å®‰å…¨å®¡è®¡æ—¥å¿—
        
        :param operation: æ“ä½œç±»å‹
        :param  æ“ä½œæ•°æ®
        :param context: å®‰å…¨ä¸Šä¸‹æ–‡
        """
        detections = self.detect_sensitive_data(data, context)
        
        if detections:
            allowed = [d for d in detections if d["allowed"]]
            blocked = [d for d in detections if not d["allowed"]]
            
            log_entry = {
                "timestamp": time.time(),
                "operation": operation,
                "context": context or self.get_current_context(),
                "sensitive_data_found": len(detections),
                "allowed_access": len(allowed),
                "blocked_access": len(blocked),
                "details": [{
                    "pattern": d["pattern_id"],
                    "value_sample": d["value"][:10] + "..." if len(d["value"]) > 10 else d["value"],
                    "allowed": d["allowed"]
                } for d in detections[:5]]  # åªå½•å‰5ä¸ª
            }
            
            self.logger.info("Security audit: %s", json.dumps(log_entry))
    
    def protect_route(self, required_context: Optional[str] = None):
        """
        è·¯ç”±ä¿æŠ¤è£…é¥°å™¨
        
        :param required_context: æ‰€éœ€çš„å®‰å…¨ä¸Šä¸‹æ–‡
        """
        def decorator(func):
            @wraps(func)
            def wrapper(*args, **kwargs):
                # è¿›å…¥å®‰å…¨ä¸Šä¸‹æ–‡
                self.enter_context(required_context)
                
                try:
                    # æ‰§è¡Œå‰å®¡è®¡
                    self.audit_log(f"enter:{func.__name__}", kwargs, required_context)
                    
                    # æ‰§è¡Œå‡½æ•°
                    result = func(*args, **kwargs)
                    
                    # æ£€æµ‹å¹¶è„±æ•è¿”å›æ•°æ®
                    if isinstance(result, (dict, list, str)):
                        result = self.redact_sensitive_data(result, required_context)
                    
                    # æ‰§è¡Œåå®¡è®¡
                    self.audit_log(f"exit:{func.__name__}", result, required_context)
                    
                    return result
                finally:
                    # é€€å‡ºå®‰å…¨ä¸Šä¸‹æ–‡
                    self.exit_context()
            return wrapper
        return decorator

# ä½¿ç”¨ç¤ºä¾‹
security = DataSecurityMiddleware()

@security.protect_route(required_context="payment-processing")
def process_payment(data: Dict) -> Dict:
    """å¤„ç†æ”¯ä»˜è¯·æ±‚ (è‡ªåŠ¨è„±æ•æ•æ„Ÿæ•°æ®)"""
    # ä¸šåŠ¡é€»è¾‘
    payment_result = {
        "status": "success",
        "transaction_id": "txn-123456",
        "card_number": data["card_number"],  # å°†è¢«è‡ªåŠ¨è„±æ•
        "amount": data["amount"]
    }
    return payment_result
```

---

## ğŸ“‘ ç›¸å…³ç« èŠ‚

| å‰åº | å½“å‰ | åç»­ |
|-----|------|------|
| [5.7](ch5-7.md) | **5.8** | [5.9](ch5-9.md) |

**å¿«é€Ÿé“¾æ¥ï¼š**
- [â† è¿”å›ç¬¬5ç« é¦–é ](ch5-index.md)
